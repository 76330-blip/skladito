<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SKLADITO v2.8.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
body { font-family:-apple-system,BlinkMacSystemFont,'Roboto','Segoe UI',sans-serif; background:#F5F5F5; color:#333; padding-bottom:200px; }

.header { background:linear-gradient(135deg,#4A90E2 0%,#357ABD 100%); color:white; padding:15px 20px; box-shadow:0 2px 10px rgba(0,0,0,0.1); position:sticky; top:0; z-index:100; }
.header-content { display:flex; align-items:center; }
.back-btn { background:none; border:none; color:white; font-size:24px; cursor:pointer; padding:5px 10px; margin-right:10px; }
.header-title { flex:1; }
.header h1 { font-size:20px; font-weight:600; }
.burger-btn { background:none; border:none; color:white; font-size:24px; cursor:pointer; padding:5px; }

.burger-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:200; }
.burger-overlay.active { display:block; }
.burger-menu { position:fixed; top:0; right:-300px; width:280px; height:100%; background:white; z-index:201; transition:right 0.3s; overflow-y:auto; }
.burger-menu.active { right:0; }
.burger-header { background:linear-gradient(135deg,#4A90E2,#357ABD); color:white; padding:30px 20px; }
.burger-header h2 { font-size:18px; }
.burger-header p { font-size:12px; opacity:0.8; margin-top:5px; }
.burger-item { display:flex; align-items:center; padding:15px 20px; border-bottom:1px solid #eee; cursor:pointer; }
.burger-item:active { background:#f5f5f5; }
.burger-item-icon { font-size:24px; margin-right:15px; }
.burger-item-text { flex:1; }
.burger-item-title { font-weight:600; font-size:15px; }
.burger-item-subtitle { font-size:12px; color:#999; margin-top:2px; }

.container { max-width:800px; margin:0 auto; padding:20px; }
.empty-state { text-align:center; padding:60px 20px; color:#999; }
.empty-state-icon { font-size:64px; margin-bottom:15px; }
.empty-state-text { font-size:18px; margin-bottom:20px; }

.card { background:white; border-radius:12px; padding:15px; margin-bottom:12px; box-shadow:0 2px 8px rgba(0,0,0,0.08); cursor:pointer; transition:transform 0.2s; }
.card:active { transform:scale(0.98); }
.card-header { display:flex; align-items:center; margin-bottom:8px; }
.card-icon { font-size:32px; margin-right:12px; flex-shrink:0; }
.card-thumb { width:50px; height:50px; border-radius:8px; object-fit:cover; margin-right:12px; flex-shrink:0; }
.card-title { flex:1; font-size:18px; font-weight:600; }
.card-badge { background:#4A90E2; color:white; padding:4px 10px; border-radius:12px; font-size:12px; font-weight:600; }
.card-info { color:#666; font-size:14px; margin-top:5px; }
.card-photo { width:100%; max-height:200px; object-fit:cover; border-radius:8px; margin-top:10px; }

.btn { background:#4A90E2; color:white; border:none; padding:14px 24px; border-radius:12px; font-size:16px; font-weight:600; cursor:pointer; width:100%; margin-top:10px; transition:background 0.2s; }
.btn:active { background:#357ABD; }
.btn-secondary { background:#6c757d; }
.btn-danger { background:#dc3545; }
.btn-small { padding:8px 16px; font-size:14px; width:auto; display:inline-block; margin:5px; }

.action-bar { display:flex; gap:10px; margin-top:15px; }
.action-bar .action-btn { flex:1; padding:14px; border:none; border-radius:12px; font-size:22px; cursor:pointer; text-align:center; transition:transform 0.15s; }
.action-bar .action-btn:active { transform:scale(0.93); }
.action-btn-save { background:#4A90E2; color:white; }
.action-btn-delete { background:#dc3545; color:white; }
.action-btn-cancel { background:#e9ecef; color:#333; }

.modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; padding:20px; overflow-y:auto; }
.modal.active { display:flex; align-items:center; justify-content:center; }
.modal-content { background:white; border-radius:16px; padding:24px; max-width:500px; width:100%; max-height:90vh; overflow-y:auto; }
.modal-header { font-size:20px; font-weight:600; margin-bottom:20px; }

.form-group { margin-bottom:20px; }
.form-label { display:block; margin-bottom:8px; font-weight:600; font-size:14px; }
.form-input { width:100%; padding:12px; border:2px solid #ddd; border-radius:8px; font-size:16px; }
.form-input:focus { outline:none; border-color:#4A90E2; }
.form-select { width:100%; padding:12px; border:2px solid #ddd; border-radius:8px; font-size:16px; background:white; }

.search-bar { position:relative; margin-bottom:20px; }
.search-input { width:100%; padding:12px 40px 12px 12px; border:2px solid #ddd; border-radius:12px; font-size:16px; }
.search-icon { position:absolute; right:12px; top:50%; transform:translateY(-50%); font-size:20px; color:#999; }

.fab { position:fixed; bottom:80px; right:20px; width:56px; height:56px; background:#4A90E2; color:white; border:none; border-radius:50%; font-size:24px; box-shadow:0 4px 12px rgba(0,0,0,0.3); cursor:pointer; z-index:100; }
.fab-scan { position:fixed; bottom:80px; left:20px; width:56px; height:56px; background:#28a745; color:white; border:none; border-radius:50%; font-size:24px; box-shadow:0 4px 12px rgba(0,0,0,0.3); cursor:pointer; z-index:100; }
.fab:active, .fab-scan:active { transform:scale(0.95); }
.fab-menu { position:fixed; bottom:150px; right:20px; z-index:99; display:none; }
.fab-menu.active { display:block; }
.fab-menu-item { background:white; padding:12px 20px; margin-bottom:10px; border-radius:24px; box-shadow:0 2px 8px rgba(0,0,0,0.2); cursor:pointer; white-space:nowrap; }
.fab-menu-item:active { transform:scale(0.95); }

.loading { text-align:center; padding:40px; color:#999; }
.spinner { border:4px solid #f3f3f3; border-top:4px solid #4A90E2; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:0 auto; }
@keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }

.photo-preview { width:100%; max-height:300px; object-fit:cover; border-radius:8px; margin-top:10px; }
.photo-upload { display:none; }
.photo-upload-btn { display:flex; align-items:center; justify-content:center; padding:12px; border:2px dashed #ddd; border-radius:8px; cursor:pointer; color:#666; margin-top:10px; }
.photo-actions { display:flex; gap:10px; margin-top:10px; }
.alert { padding:12px 16px; border-radius:8px; margin-bottom:16px; }
.alert-error { background:#f8d7da; color:#721c24; }
.toast { position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:#333; color:white; padding:12px 24px; border-radius:24px; font-size:14px; z-index:9999; opacity:0; transition:opacity 0.3s; pointer-events:none; }
.toast.show { opacity:1; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <button class="back-btn" id="backBtn" style="display:none;">‚Üê</button>
            <div class="header-title" onclick="renderMain()" style="cursor:pointer;">
                <h1>üì¶ SKLADITO LAN</h1>
            </div>
            <button class="burger-btn" id="burgerBtn">‚ò∞</button>
        </div>
    </div>

    <div class="burger-overlay" id="burgerOverlay" onclick="closeBurgerMenu()"></div>
    <div class="burger-menu" id="burgerMenu">
        <div class="burger-header">
            <h2>üì¶ SKLADITO LAN</h2>
            <p id="burgerStatus">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</p>
        </div>
        <div class="burger-item" onclick="openCategoriesModal(); closeBurgerMenu();">
            <div class="burger-item-icon">üè∑Ô∏è</div>
            <div class="burger-item-text">
                <div class="burger-item-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
                <div class="burger-item-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</div>
            </div>
        </div>
        <div class="burger-item" onclick="openShoppingList(); closeBurgerMenu();">
            <div class="burger-item-icon">üõí</div>
            <div class="burger-item-text">
                <div class="burger-item-title">–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</div>
                <div class="burger-item-subtitle" id="shoppingBadge">–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–∫—É–ø–∏—Ç—å</div>
            </div>
        </div>
        <div class="burger-item" onclick="openWriteOff(); closeBurgerMenu();">
            <div class="burger-item-icon">üìù</div>
            <div class="burger-item-text">
                <div class="burger-item-title">–°–ø–∏—Å–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç</div>
                <div class="burger-item-subtitle">–£–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="breadcrumbsBar" style="display:none;padding:8px 0;font-size:13px;color:#666;">
            <span id="breadcrumbs"></span>
        </div>
        <div id="searchContainer" style="display:none;">
            <div class="search-bar">
                <input type="text" class="search-input" id="searchInput" placeholder="–ü–æ–∏—Å–∫...">
                <span class="search-icon">üîç</span>
            </div>
        </div>
        <div id="mainContent">
            <div class="loading"><div class="spinner"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p></div>
        </div>
    </div>

    <button class="fab" id="fabBtn" style="display:none;">+</button>
    <button class="fab-scan" onclick="openScannerModal()">üì∑</button>
    <div class="fab-menu" id="fabMenu">
        <div class="fab-menu-item" onclick="openAddContainerModal()">üì¶ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä</div>
        <div class="fab-menu-item" onclick="openAddItemModal()">üìå –ü—Ä–µ–¥–º–µ—Ç</div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê: –ù–û–í–´–ô –ö–û–ù–¢–ï–ô–ù–ï–† -->
    <div class="modal" id="addContainerModal">
        <div class="modal-content">
            <div class="modal-header">–ù–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä</div>
            <form id="addContainerForm">
                <div class="form-group">
                    <label class="form-label">–ù–æ–º–µ—Ä</label>
                    <input type="text" class="form-input" id="containerNumber" maxlength="4" pattern="[0-9]{1,4}" style="font-size:24px;text-align:center;font-weight:700;letter-spacing:4px;width:120px;">
                </div>
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                    <input type="text" class="form-input" id="containerName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–§–æ—Ç–æ</label>
                    <input type="file" class="photo-upload" id="containerPhoto" accept="image/*">
                    <div class="photo-upload-btn" onclick="document.getElementById('containerPhoto').click()">üì∑ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</div>
                    <img id="containerPhotoPreview" class="photo-preview" style="display:none;">
                </div>
                <div class="action-bar">
                    <button type="submit" class="action-btn action-btn-save">‚úì</button>
                    <button type="button" class="action-btn action-btn-cancel" onclick="closeModal('addContainerModal')">‚úï</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê: –ù–û–í–´–ô –ü–†–ï–î–ú–ï–¢ -->
    <div class="modal" id="addItemModal">
        <div class="modal-content">
            <div class="modal-header">–ù–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç</div>
            <form id="addItemForm">
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                    <input type="text" class="form-input" id="itemName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
                    <input type="number" class="form-input" id="itemQuantity" min="0" value="1" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–ú–∏–Ω. –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ <span style="color:#999;font-weight:400;">(–¥–ª—è —Å–ø–∏—Å–∫–∞ –ø–æ–∫—É–ø–æ–∫)</span></label>
                    <input type="number" class="form-input" id="itemMinQuantity" min="0" value="0">
                </div>
                <div class="form-group">
                    <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <div style="display:flex;gap:8px;">
                        <select class="form-select" id="itemCategory" style="flex:1;"><option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option></select>
                        <button type="button" class="btn btn-small" onclick="showNewCategoryInput('item')" style="width:auto;padding:10px 14px;margin:0;white-space:nowrap;">+ –ù–æ–≤–∞—è</button>
                    </div>
                    <div id="newCategoryItem" style="display:none;margin-top:8px;">
                        <div style="display:flex;gap:8px;">
                            <input type="text" class="form-input" id="newCategoryNameItem" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" style="flex:1;">
                            <button type="button" class="btn btn-small" onclick="addNewCategory('item')" style="width:auto;padding:10px 14px;margin:0;">‚úì</button>
                            <button type="button" class="btn btn-small btn-secondary" onclick="hideNewCategoryInput('item')" style="width:auto;padding:10px 14px;margin:0;">‚úï</button>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">–§–æ—Ç–æ</label>
                    <input type="file" class="photo-upload" id="itemPhoto" accept="image/*">
                    <div class="photo-upload-btn" onclick="document.getElementById('itemPhoto').click()">üì∑ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</div>
                    <img id="itemPhotoPreview" class="photo-preview" style="display:none;">
                </div>
                <div class="action-bar">
                    <button type="submit" class="action-btn action-btn-save">‚úì</button>
                    <button type="button" class="action-btn action-btn-cancel" onclick="closeModal('addItemModal')">‚úï</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê: –ö–ê–¢–ï–ì–û–†–ò–ò -->
    <div class="modal" id="categoriesModal">
        <div class="modal-content">
            <div class="modal-header">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
            <div id="categoriesList"></div>
            <div style="margin-top:15px;display:flex;gap:8px;">
                <input type="text" class="form-input" id="newCategoryNameModal" placeholder="–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è">
                <button class="btn btn-small" onclick="addCategoryFromModal()" style="width:auto;padding:10px 14px;margin:0;">+ –î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            <button class="btn btn-secondary" onclick="closeModal('categoriesModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê: –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header" id="editModalTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
            <form id="editForm">
                <div id="editFormContent"></div>
                <div class="action-bar">
                    <button type="submit" class="action-btn action-btn-save">‚úì</button>
                    <button type="button" class="action-btn action-btn-delete" id="deleteBtn">üóëÔ∏è</button>
                    <button type="button" class="action-btn action-btn-cancel" onclick="closeModal('editModal')">‚úï</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê: QR-–ö–û–î -->
    <div class="modal" id="qrModal">
        <div class="modal-content">
            <div class="modal-header">QR-–∫–æ–¥ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞</div>
            <div id="qrCard" style="background:white;padding:20px;text-align:center;border:2px solid #333;border-radius:12px;margin-bottom:20px;">
                <div id="qrCodeContainer" style="display:inline-block;margin-bottom:15px;"></div>
                <div id="qrNumber" style="font-size:48px;font-weight:900;letter-spacing:6px;color:#333;margin-bottom:8px;"></div>
                <div id="qrName" style="font-size:14px;color:#666;"></div>
            </div>
            <button class="btn" onclick="printQrCard()">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
            <button class="btn btn-secondary" onclick="closeModal('qrModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê: –°–ö–ê–ù–ï–† -->
    <div class="modal" id="scannerModal">
        <div class="modal-content" style="max-width:100%;padding:10px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <div class="modal-header" style="margin-bottom:0;">–°–∫–∞–Ω–µ—Ä</div>
                <button style="background:none;border:none;font-size:24px;cursor:pointer;" onclick="stopScanner()">‚úï</button>
            </div>
            <div style="display:flex;gap:8px;margin-bottom:10px;">
                <button class="btn btn-small" id="scanModeLook" onclick="setScanMode('look')" style="flex:1;background:#4A90E2;">üì¶ –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏?</button>
                <button class="btn btn-small" id="scanModeFind" onclick="setScanMode('find')" style="flex:1;background:#6c757d;">üîç –ù–∞–π—Ç–∏ –∫–æ—Ä–æ–±–∫—É</button>
            </div>
            <div id="findContainerSelect" style="display:none;margin-bottom:10px;">
                <select class="form-select" id="findTargetContainer"><option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä...</option></select>
            </div>
            <div id="scannerVideo" style="width:100%;border-radius:8px;overflow:hidden;background:#000;min-height:250px;"></div>
            <div id="scanResult" style="margin-top:10px;"></div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê: –†–ï–ó–£–õ–¨–¢–ê–¢ –°–ö–ê–ù–ê -->
    <div class="modal" id="scanResultModal">
        <div class="modal-content">
            <div class="modal-header" id="scanResultTitle">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ</div>
            <div id="scanResultContent"></div>
            <div style="margin:10px 0;">
                <button class="btn btn-small" id="toggleAllItems" onclick="toggleScanAllItems()" style="width:100%;">üìã –ü–æ–∫–∞–∑–∞—Ç—å –í–°–ï –ø—Ä–µ–¥–º–µ—Ç—ã</button>
            </div>
            <button class="btn" onclick="navigateToScanned()">üìÇ –û—Ç–∫—Ä—ã—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä</button>
            <button class="btn btn-secondary" onclick="closeModal('scanResultModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê: –°–ü–ò–°–û–ö –ü–û–ö–£–ü–û–ö -->
    <div class="modal" id="shoppingModal">
        <div class="modal-content">
            <div class="modal-header">üõí –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</div>
            <div id="shoppingList"></div>
            <button class="btn" onclick="shareShoppingList()" style="margin-top:15px;">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å–ø–∏—Å–∫–æ–º</button>
            <button class="btn btn-secondary" onclick="closeModal('shoppingModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê: –°–ü–ò–°–ê–ù–ò–ï -->
    <div class="modal" id="writeOffModal">
        <div class="modal-content">
            <div class="modal-header">üìù –°–ø–∏—Å–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç</div>
            <div class="form-group">
                <label class="form-label">–ü–æ–∏—Å–∫ –ø—Ä–µ–¥–º–µ—Ç–∞</label>
                <input type="text" class="form-input" id="writeOffSearch" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ..." oninput="searchWriteOff()">
            </div>
            <div id="writeOffResults" style="max-height:400px;overflow-y:auto;"></div>
            <button class="btn btn-secondary" onclick="closeModal('writeOffModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê: –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –°–ü–ò–°–ê–ù–ò–Ø -->
    <div class="modal" id="writeOffConfirmModal">
        <div class="modal-content">
            <div class="modal-header">–°–ø–∏—Å–∞—Ç—å?</div>
            <div id="writeOffConfirmContent"></div>
            <div class="form-group" style="margin-top:15px;">
                <label class="form-label">–°–∫–æ–ª—å–∫–æ —Å–ø–∏—Å–∞—Ç—å?</label>
                <input type="number" class="form-input" id="writeOffAmount" min="1" value="1" style="width:100px;text-align:center;font-size:24px;font-weight:700;">
            </div>
            <button class="btn btn-danger" onclick="confirmWriteOff()">–°–ø–∏—Å–∞—Ç—å</button>
            <button class="btn btn-secondary" onclick="closeModal('writeOffConfirmModal')">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
const API_BASE = '/api';
let state = { containers:[], items:[], categories:[], currentContainer:null, viewMode:'main', editingObject:null };

async function init() {
    try {
        updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
        const health = await fetch(`${API_BASE}/health`);
        const hd = await health.json();
        if (hd.status !== 'ok') throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
        updateStatus('‚úÖ v' + hd.version);
        document.getElementById('burgerStatus').textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ v' + hd.version;
        await loadData();
        setupEventListeners();
        renderMain();
    } catch (error) {
        console.error(error);
        showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
        updateStatus('‚ùå –û—à–∏–±–∫–∞');
    }
}

async function loadData() {
    const r = await fetch(`${API_BASE}/sync`);
    const d = await r.json();
    state.containers = d.containers || [];
    state.items = d.items || [];
    state.categories = d.categories || [];
}

function updateStatus(msg) { const b=document.getElementById('burgerStatus'); if(b) b.textContent=msg; }
function showError(msg) { document.getElementById('mainContent').innerHTML = `<div class="alert alert-error">${msg}</div>`; }

function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
}

function setupEventListeners() {
    document.getElementById('backBtn').addEventListener('click', handleBack);
    document.getElementById('fabBtn').addEventListener('click', toggleFabMenu);
    document.getElementById('burgerBtn').addEventListener('click', openBurgerMenu);
    document.getElementById('searchInput').addEventListener('input', handleSearch);
    document.getElementById('addContainerForm').addEventListener('submit', handleAddContainer);
    document.getElementById('addItemForm').addEventListener('submit', handleAddItem);
    document.getElementById('editForm').addEventListener('submit', handleEdit);
    document.getElementById('deleteBtn').addEventListener('click', handleDelete);
    document.getElementById('containerPhoto').addEventListener('change', (e) => previewPhoto(e, 'containerPhotoPreview'));
    document.getElementById('itemPhoto').addEventListener('change', (e) => previewPhoto(e, 'itemPhotoPreview'));
    document.addEventListener('click', (e) => {
        const fab = document.getElementById('fabBtn');
        const menu = document.getElementById('fabMenu');
        if (!fab.contains(e.target) && !menu.contains(e.target)) menu.classList.remove('active');
    });
}

function toggleFabMenu(e) { e.stopPropagation(); document.getElementById('fabMenu').classList.toggle('active'); }
function openBurgerMenu() { document.getElementById('burgerMenu').classList.add('active'); document.getElementById('burgerOverlay').classList.add('active'); updateShoppingBadge(); }
function closeBurgerMenu() { document.getElementById('burgerMenu').classList.remove('active'); document.getElementById('burgerOverlay').classList.remove('active'); }

function openAddContainerModal() {
    document.getElementById('fabMenu').classList.remove('active');
    document.getElementById('containerNumber').value = getNextContainerNumber(state.currentContainer);
    document.getElementById('containerName').value = '';
    document.getElementById('containerPhoto').value = '';
    document.getElementById('containerPhotoPreview').style.display = 'none';
    openModal('addContainerModal');
}

function openAddItemModal() {
    document.getElementById('fabMenu').classList.remove('active');
    fillCategorySelect('itemCategory');
    openModal('addItemModal');
}

function openCategoriesModal() {
    renderCategoriesList();
    openModal('categoriesModal');
}

// ==================== –†–ï–ù–î–ï–†–ò–ù–ì ====================

function renderMain() {
    state.viewMode = 'main'; state.currentContainer = null;
    document.getElementById('breadcrumbsBar').style.display = 'none';
    document.getElementById('backBtn').style.display = 'none';
    document.getElementById('searchContainer').style.display = 'block';
    document.getElementById('fabBtn').style.display = 'block';
    const root = state.containers.filter(c => !c.parent);
    let html = '';
    if (root.length > 0) { html += '<h3 style="margin:20px 0 12px 0;">–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã</h3>'; root.forEach(c => html += renderContainerCard(c)); }
    if (root.length === 0 && state.items.length === 0) { html += '<div class="empty-state"><div class="empty-state-icon">üì¶</div><div class="empty-state-text">–°–∫–ª–∞–¥ –ø—É—Å—Ç</div><div>–ù–∞–∂–º–∏—Ç–µ + —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</div></div>'; }
    document.getElementById('mainContent').innerHTML = html;
}

function renderContainerCard(container) {
    const children = state.containers.filter(c => c.parent === container.id).length;
    const items = state.items.filter(i => i.container === container.id).length;
    const total = children + items;
    const num = container.number || '?';
    const thumb = container.photo ? `<img src="${container.photo}" class="card-thumb">` : `<div class="card-icon">üì¶</div>`;
    return `
        <div class="card" onclick="openContainer('${container.id}')">
            <div class="card-header">
                ${thumb}
                <div class="card-title"><span style="color:#4A90E2;font-family:'Courier New',monospace;font-weight:700;">#${num}</span> ${container.name}</div>
                ${total > 0 ? `<div class="card-badge">${total}</div>` : ''}
            </div>
            <div class="card-info">${children > 0 ? '–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤: '+children+' ' : ''}${items > 0 ? '–ü—Ä–µ–¥–º–µ—Ç–æ–≤: '+items : ''}${total === 0 ? '–ü—É—Å—Ç–æ' : ''}</div>
        </div>`;
}

function renderItemCard(item) {
    const cat = state.categories.find(c => c.id === item.category);
    const belowMin = item.minQuantity > 0 && item.quantity < item.minQuantity;
    const thumb = item.photo ? `<img src="${item.photo}" class="card-thumb">` : `<div class="card-icon">${cat ? cat.icon : 'üìå'}</div>`;
    let info = [];
    if (cat) info.push(`${cat.icon} ${cat.name}`);
    if (belowMin) info.push(`<span style="color:#dc3545;font-weight:600;">‚ö†Ô∏è –ù—É–∂–Ω–æ –∫—É–ø–∏—Ç—å (–º–∏–Ω: ${item.minQuantity})</span>`);
    return `
        <div class="card" onclick="editItem('${item.id}')" ${belowMin ? 'style="border-left:4px solid #dc3545;"' : ''}>
            <div class="card-header">
                ${thumb}
                <div class="card-title">${item.name}</div>
                <div class="card-badge" ${belowMin ? 'style="background:#dc3545;"' : ''}>√ó${item.quantity}</div>
            </div>
            ${info.length > 0 ? `<div class="card-info">${info.join(' ¬∑ ')}</div>` : ''}
        </div>`;
}

function openContainer(containerId) {
    state.viewMode = 'container'; state.currentContainer = containerId;
    const container = state.containers.find(c => c.id === containerId);
    if (!container) return;
    document.getElementById('breadcrumbs').textContent = getContainerPath(containerId);
    document.getElementById('breadcrumbsBar').style.display = 'block';
    document.getElementById('backBtn').style.display = 'block';
    document.getElementById('searchContainer').style.display = 'none';
    document.getElementById('fabBtn').style.display = 'block';
    const childContainers = state.containers.filter(c => c.parent === containerId);
    const items = state.items.filter(i => i.container === containerId);
    let html = `
        <div class="card" style="padding:12px;">
            <div class="card-header" style="margin-bottom:0;">
                ${container.photo ? `<img src="${container.photo}" class="card-thumb">` : `<div class="card-icon">üì¶</div>`}
                <div class="card-title"><span style="color:#4A90E2;font-family:'Courier New',monospace;font-weight:700;">#${container.number||'?'}</span> ${container.name}</div>
            </div>
            <div style="display:flex;gap:8px;margin-top:10px;">
                <button onclick="editContainer('${containerId}')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#4A90E2;color:white;font-size:18px;cursor:pointer;">‚úèÔ∏è</button>
                <button onclick="showQRCode('${containerId}')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#28a745;color:white;font-size:18px;cursor:pointer;">QR</button>
                <button onclick="openScannerModal()" style="flex:1;padding:10px;border:none;border-radius:10px;background:#fd7e14;color:white;font-size:18px;cursor:pointer;">üì∑</button>
            </div>
        </div>`;
    if (childContainers.length > 0) { html += '<h3 style="margin:20px 0 12px 0;">–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã</h3>'; childContainers.forEach(c => html += renderContainerCard(c)); }
    if (items.length > 0) { html += '<h3 style="margin:20px 0 12px 0;">–ü—Ä–µ–¥–º–µ—Ç—ã</h3>'; items.forEach(i => html += renderItemCard(i)); }
    if (childContainers.length === 0 && items.length === 0) { html += '<div class="empty-state"><div class="empty-state-icon">üì≠</div><div class="empty-state-text">–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—É—Å—Ç</div></div>'; }
    document.getElementById('mainContent').innerHTML = html;
}

function showCategory(categoryId) {
    state.viewMode = 'category';
    const cat = state.categories.find(c => c.id === categoryId);
    if (!cat) return;
    document.getElementById('breadcrumbs').textContent = `–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${cat.name}`;
    document.getElementById('breadcrumbsBar').style.display = 'block';
    document.getElementById('backBtn').style.display = 'block';
    document.getElementById('searchContainer').style.display = 'none';
    document.getElementById('fabBtn').style.display = 'none';
    const items = state.items.filter(i => i.category === categoryId);
    let html = `<h2 style="margin-bottom:20px;">${cat.icon} ${cat.name}</h2>`;
    if (items.length > 0) { items.forEach(item => { const c = state.containers.find(cc => cc.id === item.container); let ih = renderItemCard(item); if (c) ih = ih.replace('</div>','<div class="card-info">üìç '+getContainerPath(c.id)+'</div></div>'); html += ih; }); }
    else { html += '<div class="empty-state"><div class="empty-state-icon">üîç</div><div class="empty-state-text">–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div></div>'; }
    document.getElementById('mainContent').innerHTML = html;
}

// ==================== –ö–ê–¢–ï–ì–û–†–ò–ò ====================

function renderCategoriesList() {
    let html = '';
    state.categories.forEach(cat => {
        const count = state.items.filter(i => i.category === cat.id).length;
        html += `<div style="display:flex;align-items:center;padding:12px 0;border-bottom:1px solid #eee;">
            <span style="font-size:28px;margin-right:12px;cursor:pointer;" onclick="changeCategoryIcon('${cat.id}')">${cat.icon}</span>
            <div style="flex:1;cursor:pointer;" onclick="showCategoryFromList('${cat.id}')"><div style="font-weight:600;">${cat.name}</div><div style="font-size:12px;color:#999;">–ü—Ä–µ–¥–º–µ—Ç–æ–≤: ${count}</div></div>
            <button onclick="renameCategoryPrompt('${cat.id}')" style="background:none;border:none;font-size:18px;cursor:pointer;padding:5px;">‚úèÔ∏è</button>
            <button onclick="deleteCategoryPrompt('${cat.id}')" style="background:none;border:none;font-size:18px;cursor:pointer;padding:5px;">üóëÔ∏è</button>
        </div>`;
    });
    if (state.categories.length === 0) html = '<div style="text-align:center;color:#999;padding:20px;">–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π</div>';
    document.getElementById('categoriesList').innerHTML = html;
}

function showCategoryFromList(id) { closeModal('categoriesModal'); showCategory(id); }

function fillCategorySelect(selectId) {
    const sel = document.getElementById(selectId || 'itemCategory');
    const val = sel.value;
    sel.innerHTML = '<option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>';
    state.categories.forEach(c => { sel.innerHTML += `<option value="${c.id}" ${c.id===val?'selected':''}>${c.icon} ${c.name}</option>`; });
}

function showNewCategoryInput(ctx) { document.getElementById('newCategory'+(ctx==='item'?'Item':'Edit')).style.display='block'; }
function hideNewCategoryInput(ctx) { document.getElementById('newCategory'+(ctx==='item'?'Item':'Edit')).style.display='none'; }

async function addNewCategory(ctx) {
    const inputId = 'newCategoryName'+(ctx==='item'?'Item':'Edit');
    const selectId = ctx==='item'?'itemCategory':'editCategory';
    const name = document.getElementById(inputId).value.trim();
    if (!name) { showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'); return; }
    const newCat = { id:'cat'+Date.now(), name, icon:'üìÇ', order:state.categories.length };
    try {
        await fetch(`${API_BASE}/categories`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(newCat) });
        await loadData();
        fillCategorySelect(selectId);
        document.getElementById(selectId).value = newCat.id;
        hideNewCategoryInput(ctx);
        showToast(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è "${name}" –¥–æ–±–∞–≤–ª–µ–Ω–∞!`);
    } catch(e) { alert('–û—à–∏–±–∫–∞: '+e.message); }
}

async function addCategoryFromModal() {
    const name = document.getElementById('newCategoryNameModal').value.trim();
    if (!name) { showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'); return; }
    const newCat = { id:'cat'+Date.now(), name, icon:'üìÇ', order:state.categories.length };
    try {
        await fetch(`${API_BASE}/categories`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(newCat) });
        await loadData();
        document.getElementById('newCategoryNameModal').value = '';
        renderCategoriesList();
        showToast(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è "${name}" –¥–æ–±–∞–≤–ª–µ–Ω–∞!`);
    } catch(e) { alert('–û—à–∏–±–∫–∞: '+e.message); }
}

async function deleteCategoryPrompt(catId) {
    const cat = state.categories.find(c => c.id === catId);
    if (!cat) return;
    const count = state.items.filter(i => i.category === catId).length;
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å "${cat.name}"?${count>0?' –£ '+count+' –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –±—É–¥–µ—Ç —Å–Ω—è—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è.':''}`)) return;
    try {
        await fetch(`${API_BASE}/categories/${catId}`, { method:'DELETE' });
        await loadData();
        renderCategoriesList();
        showToast('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞');
    } catch(e) { alert('–û—à–∏–±–∫–∞: '+e.message); }
}

async function renameCategoryPrompt(catId) {
    const cat = state.categories.find(c => c.id === catId);
    if (!cat) return;
    const newName = prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:', cat.name);
    if (!newName || !newName.trim()) return;
    cat.name = newName.trim();
    try {
        await fetch(`${API_BASE}/categories/${catId}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(cat) });
        await loadData();
        renderCategoriesList();
        showToast('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞');
    } catch(e) { alert('–û—à–∏–±–∫–∞: '+e.message); }
}

function changeCategoryIcon(catId) {
    const cat = state.categories.find(c => c.id === catId);
    if (!cat) return;
    const icons = ['üìÇ','üîß','üìù','üè†','‚ö°','üëï','üéÆ','üç≥','üíä','üß¥','üßπ','üìö','üé®','üèãÔ∏è','üîë','ü™¥','üß∏','üéÅ','üõ†Ô∏è','üß≤','üì¶','ü•´','üßª','üí°','üîå','üß§','üëü','üéí','üß≥','üì∑'];
    let html = '<div style="display:flex;flex-wrap:wrap;gap:8px;padding:10px;">';
    icons.forEach(icon => { html += `<span style="font-size:28px;cursor:pointer;padding:6px;border-radius:8px;${icon===cat.icon?'background:#4A90E233;':''}" onclick="setCategoryIcon('${catId}','${icon}')">${icon}</span>`; });
    html += '</div>';
    document.getElementById('categoriesList').innerHTML = html;
}

async function setCategoryIcon(catId, icon) {
    if (!icon) return;
    const cat = state.categories.find(c => c.id === catId);
    if (!cat) return;
    cat.icon = icon;
    try {
        await fetch(`${API_BASE}/categories/${catId}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(cat) });
        await loadData();
        renderCategoriesList();
        showToast('–ò–∫–æ–Ω–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∞');
    } catch(e) { alert('–û—à–∏–±–∫–∞: '+e.message); }
}

// ==================== –ù–û–ú–ï–†–ê –ö–û–ù–¢–ï–ô–ù–ï–†–û–í ====================

function getNextContainerNumber(parentId) {
    const siblings = state.containers.filter(c => c.parent === parentId);
    const used = siblings.map(c => parseInt(c.number) || 0);
    let next = 1; while (used.includes(next)) next++;
    return String(next).padStart(4, '0');
}

function isNumberUnique(number, parentId, excludeId) {
    return !state.containers.filter(c => c.parent === parentId && c.id !== excludeId).some(c => c.number === number);
}

function getDescendantIds(containerId) {
    let ids = [];
    state.containers.filter(c => c.parent === containerId).forEach(child => { ids.push(child.id); ids = ids.concat(getDescendantIds(child.id)); });
    return ids;
}

// ==================== CRUD ====================

async function handleAddContainer(e) {
    e.preventDefault();
    const name = document.getElementById('containerName').value;
    const numberRaw = document.getElementById('containerNumber').value;
    const number = String(parseInt(numberRaw)||1).padStart(4,'0');
    if (!isNumberUnique(number, state.currentContainer, null)) { showToast(`–ù–æ–º–µ—Ä ${number} —É–∂–µ –∑–∞–Ω—è—Ç!`); return; }
    const photoFile = document.getElementById('containerPhoto').files[0];
    let photo = null;
    if (photoFile) photo = await fileToBase64(photoFile);
    const container = { id:'c'+Date.now(), number, name, photo, parent:state.currentContainer, created:new Date().toISOString() };
    try {
        const r = await fetch(`${API_BASE}/containers`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(container) });
        if (!r.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è');
        await loadData(); closeModal('addContainerModal');
        if (state.currentContainer) openContainer(state.currentContainer); else renderMain();
    } catch(e) { alert('–û—à–∏–±–∫–∞: '+e.message); }
}

async function handleAddItem(e) {
    e.preventDefault();
    const name = document.getElementById('itemName').value;
    const quantity = parseInt(document.getElementById('itemQuantity').value);
    const minQuantity = parseInt(document.getElementById('itemMinQuantity').value)||0;
    const category = document.getElementById('itemCategory').value||null;
    const photoFile = document.getElementById('itemPhoto').files[0];
    let photo = null;
    if (photoFile) photo = await fileToBase64(photoFile);
    const item = { id:'i'+Date.now(), name, quantity, minQuantity, category, photo, container:state.currentContainer, created:new Date().toISOString() };
    try {
        const r = await fetch(`${API_BASE}/items`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(item) });
        if (!r.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è');
        await loadData(); closeModal('addItemModal'); openContainer(state.currentContainer);
    } catch(e) { alert('–û—à–∏–±–∫–∞: '+e.message); }
}

function editContainer(containerId) {
    const container = state.containers.find(c => c.id === containerId);
    if (!container) return;
    state.editingObject = { type:'container', data:{...container} };
    document.getElementById('editModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä';
    const descendants = getDescendantIds(containerId);
    const possibleParents = state.containers.filter(c => c.id !== containerId && !descendants.includes(c.id));
    let html = `
        <input type="hidden" id="editType" value="container">
        <input type="hidden" id="editId" value="${container.id}">
        <div class="form-group"><label class="form-label">–ù–æ–º–µ—Ä</label>
            <input type="text" class="form-input" id="editNumber" value="${container.number||''}" maxlength="4" style="font-size:24px;text-align:center;font-weight:700;letter-spacing:4px;width:120px;">
        </div>
        <div class="form-group"><label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input type="text" class="form-input" id="editName" value="${container.name}" required>
        </div>
        <div class="form-group"><label class="form-label">üìç –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ</label>
            <select class="form-select" id="editParent">
                <option value="" ${!container.parent?'selected':''}>üè† –ì–ª–∞–≤–Ω–∞—è (–∫–æ—Ä–µ–Ω—å)</option>
                ${possibleParents.map(c => `<option value="${c.id}" ${c.id===container.parent?'selected':''}>${c.number?'#'+c.number+' ':''}${c.name}</option>`).join('')}
            </select>
        </div>`;
    if (container.photo) { html += `<div class="form-group"><label class="form-label">–§–æ—Ç–æ</label><img src="${container.photo}" class="photo-preview" id="editPhotoPreview"><div class="photo-actions"><button type="button" class="btn-small" onclick="document.getElementById('editPhotoInput').click()">–ó–∞–º–µ–Ω–∏—Ç—å</button><button type="button" class="btn-small btn-danger" onclick="deletePhoto()">–£–¥–∞–ª–∏—Ç—å</button></div></div>`; }
    else { html += `<div class="form-group"><label class="form-label">–§–æ—Ç–æ</label><div class="photo-upload-btn" onclick="document.getElementById('editPhotoInput').click()">üì∑ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</div><img id="editPhotoPreview" class="photo-preview" style="display:none;"></div>`; }
    html += '<input type="file" class="photo-upload" id="editPhotoInput" accept="image/*">';
    document.getElementById('editFormContent').innerHTML = html;
    document.getElementById('editPhotoInput').addEventListener('change', (e) => previewPhoto(e, 'editPhotoPreview'));
    openModal('editModal');
}

function editItem(itemId) {
    const item = state.items.find(i => i.id === itemId);
    if (!item) return;
    state.editingObject = { type:'item', data:{...item} };
    document.getElementById('editModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç';
    let html = `
        <input type="hidden" id="editType" value="item"><input type="hidden" id="editId" value="${item.id}">
        <div class="form-group"><label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" class="form-input" id="editName" value="${item.name}" required></div>
        <div class="form-group"><label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label><input type="number" class="form-input" id="editQuantity" value="${item.quantity}" min="0" required></div>
        <div class="form-group"><label class="form-label">–ú–∏–Ω. –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</label><input type="number" class="form-input" id="editMinQuantity" value="${item.minQuantity||0}" min="0"></div>
        <div class="form-group"><label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            <div style="display:flex;gap:8px;">
                <select class="form-select" id="editCategory" style="flex:1;"><option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>${state.categories.map(c=>`<option value="${c.id}" ${c.id===item.category?'selected':''}>${c.icon} ${c.name}</option>`).join('')}</select>
                <button type="button" class="btn btn-small" onclick="showNewCategoryInput('edit')" style="width:auto;padding:10px 14px;margin:0;white-space:nowrap;">+ –ù–æ–≤–∞—è</button>
            </div>
            <div id="newCategoryEdit" style="display:none;margin-top:8px;"><div style="display:flex;gap:8px;"><input type="text" class="form-input" id="newCategoryNameEdit" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" style="flex:1;"><button type="button" class="btn btn-small" onclick="addNewCategory('edit')" style="width:auto;padding:10px 14px;margin:0;">‚úì</button><button type="button" class="btn btn-small btn-secondary" onclick="hideNewCategoryInput('edit')" style="width:auto;padding:10px 14px;margin:0;">‚úï</button></div></div>
        </div>`;
    if (item.photo) { html += `<div class="form-group"><label class="form-label">–§–æ—Ç–æ</label><img src="${item.photo}" class="photo-preview" id="editPhotoPreview"><div class="photo-actions"><button type="button" class="btn-small" onclick="document.getElementById('editPhotoInput').click()">–ó–∞–º–µ–Ω–∏—Ç—å</button><button type="button" class="btn-small btn-danger" onclick="deletePhoto()">–£–¥–∞–ª–∏—Ç—å</button></div></div>`; }
    else { html += `<div class="form-group"><label class="form-label">–§–æ—Ç–æ</label><div class="photo-upload-btn" onclick="document.getElementById('editPhotoInput').click()">üì∑ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</div><img id="editPhotoPreview" class="photo-preview" style="display:none;"></div>`; }
    html += '<input type="file" class="photo-upload" id="editPhotoInput" accept="image/*">';
    document.getElementById('editFormContent').innerHTML = html;
    document.getElementById('editPhotoInput').addEventListener('change', (e) => previewPhoto(e, 'editPhotoPreview'));
    openModal('editModal');
}

function deletePhoto() { const p=document.getElementById('editPhotoPreview'); p.style.display='none'; p.src=''; state.editingObject.data.photo=null; }

async function handleEdit(e) {
    e.preventDefault();
    const type=document.getElementById('editType').value, id=document.getElementById('editId').value, name=document.getElementById('editName').value;
    const photoInput=document.getElementById('editPhotoInput');
    let newPhoto=null;
    if (photoInput.files[0]) newPhoto = await fileToBase64(photoInput.files[0]);
    try {
        if (type==='container') {
            const c=state.containers.find(x=>x.id===id);
            c.name=name;
            const ni=document.getElementById('editNumber');
            if (ni) { const nn=ni.value?String(parseInt(ni.value)).padStart(4,'0'):c.number; if(nn!==c.number&&!isNumberUnique(nn,c.parent,c.id)){showToast('–ù–æ–º–µ—Ä '+nn+' —É–∂–µ –∑–∞–Ω—è—Ç!');return;} c.number=nn; }
            const ps=document.getElementById('editParent');
            if (ps) { const np=ps.value||null; c.parent=np; }
            if (newPhoto) c.photo=newPhoto;
            if (state.editingObject.data.photo===null) c.photo=null;
            const r=await fetch(`${API_BASE}/containers/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(c) });
            if (!r.ok) throw new Error('–û—à–∏–±–∫–∞');
        } else {
            const item=state.items.find(x=>x.id===id);
            item.name=name; item.quantity=parseInt(document.getElementById('editQuantity').value); item.minQuantity=parseInt(document.getElementById('editMinQuantity').value)||0;
            item.category=document.getElementById('editCategory').value||null;
            if (newPhoto) item.photo=newPhoto;
            if (state.editingObject.data.photo===null) item.photo=null;
            const r=await fetch(`${API_BASE}/items/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(item) });
            if (!r.ok) throw new Error('–û—à–∏–±–∫–∞');
        }
        await loadData(); closeModal('editModal');
        if (state.viewMode==='container') openContainer(state.currentContainer); else renderMain();
    } catch(err) { alert('–û—à–∏–±–∫–∞: '+err.message); }
}

async function handleDelete() {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
    const type=document.getElementById('editType').value, id=document.getElementById('editId').value;
    try {
        if (type==='container') {
            const r=await fetch(`${API_BASE}/containers/${id}`, { method:'DELETE' });
            if (!r.ok) { const e=await r.json(); throw new Error(e.error||'–û—à–∏–±–∫–∞'); }
        } else {
            const r=await fetch(`${API_BASE}/items/${id}`, { method:'DELETE' });
            if (!r.ok) throw new Error('–û—à–∏–±–∫–∞');
        }
        await loadData(); closeModal('editModal');
        if (state.viewMode==='container') openContainer(state.currentContainer); else renderMain();
    } catch(err) { alert('–û—à–∏–±–∫–∞: '+err.message); }
}

// ==================== –ù–ê–í–ò–ì–ê–¶–ò–Ø/–ü–û–ò–°–ö ====================

function handleBack() {
    if (state.viewMode==='category') { renderMain(); return; }
    if (!state.currentContainer) { renderMain(); return; }
    const c=state.containers.find(x=>x.id===state.currentContainer);
    if (c&&c.parent) openContainer(c.parent); else renderMain();
}

function handleSearch(e) {
    const q=e.target.value.toLowerCase().trim();
    if (q.length<2) { renderMain(); return; }
    state.viewMode='search';
    document.getElementById('backBtn').style.display='block';
    document.getElementById('fabBtn').style.display='none';
    const foundC=state.containers.filter(c=>c.name.toLowerCase().includes(q));
    const foundI=state.items.filter(i=>i.name.toLowerCase().includes(q));
    let html=`<h3 style="margin:20px 0 12px 0;">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã: ${foundC.length+foundI.length}</h3>`;
    foundC.forEach(c=>html+=renderContainerCard(c));
    foundI.forEach(i=>{let ih=renderItemCard(i);const c=state.containers.find(x=>x.id===i.container);if(c)ih=ih.replace('</div>','<div class="card-info">üìç '+getContainerPath(c.id)+'</div></div>');html+=ih;});
    if(foundC.length===0&&foundI.length===0) html+='<div class="empty-state"><div class="empty-state-icon">üîç</div><div class="empty-state-text">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div></div>';
    document.getElementById('mainContent').innerHTML=html;
}

function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

function previewPhoto(e, previewId) {
    const file=e.target.files[0]; if (!file) return;
    const reader=new FileReader();
    reader.onload=function(ev){ const img=document.getElementById(previewId); img.src=ev.target.result; img.style.display='block'; };
    reader.readAsDataURL(file);
}

function getContainerPath(containerId) {
    const c=state.containers.find(x=>x.id===containerId);
    if (!c) return '';
    let path=c.name, cur=c;
    while(cur.parent){ const p=state.containers.find(x=>x.id===cur.parent); if(!p)break; path=p.name+' > '+path; cur=p; }
    return '–ì–ª–∞–≤–Ω–∞—è > '+path;
}

function fileToBase64(file) { return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

// ==================== QR-–ö–û–î ====================

function showQRCode(containerId) {
    const c=state.containers.find(x=>x.id===containerId); if(!c)return;
    const qc=document.getElementById('qrCodeContainer'); qc.innerHTML='';
    new QRCode(qc, { text:c.id, width:200, height:200, colorDark:'#333', colorLight:'#fff', correctLevel:QRCode.CorrectLevel.M });
    document.getElementById('qrNumber').textContent=c.number||'----';
    document.getElementById('qrName').textContent=c.name;
    openModal('qrModal');
}

function printQrCard() {
    const w=window.open('','','width=400,height=500');
    w.document.write(`<html><head><title>QR</title><style>body{margin:0;padding:20px;text-align:center;font-family:Arial,sans-serif;}.number{font-size:64px;font-weight:900;letter-spacing:8px;margin:15px 0 5px;}.name{font-size:16px;color:#666;}img{width:200px;height:200px;}</style></head><body>${document.getElementById('qrCodeContainer').innerHTML}<div class="number">${document.getElementById('qrNumber').textContent}</div><div class="name">${document.getElementById('qrName').textContent}</div></body></html>`);
    w.document.close(); setTimeout(()=>{w.print();w.close();},500);
}

// ==================== –°–ö–ê–ù–ï–† ====================

let html5QrCode=null, scanMode='look', lastScannedId=null, scanShowAllItems=false;

function openScannerModal() {
    document.getElementById('fabMenu').classList.remove('active');
    scanMode='look'; lastScannedId=null;
    document.getElementById('scanResult').innerHTML='';
    document.getElementById('scanModeLook').style.background='#4A90E2';
    document.getElementById('scanModeFind').style.background='#6c757d';
    document.getElementById('findContainerSelect').style.display='none';
    openModal('scannerModal');
    startScanner();
}

function setScanMode(mode) {
    scanMode=mode; lastScannedId=null; document.getElementById('scanResult').innerHTML='';
    if(mode==='look'){document.getElementById('scanModeLook').style.background='#4A90E2';document.getElementById('scanModeFind').style.background='#6c757d';document.getElementById('findContainerSelect').style.display='none';}
    else{document.getElementById('scanModeLook').style.background='#6c757d';document.getElementById('scanModeFind').style.background='#4A90E2';document.getElementById('findContainerSelect').style.display='block';fillFindSelect();}
}

function fillFindSelect() {
    const s=document.getElementById('findTargetContainer'); s.innerHTML='<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä...</option>';
    state.containers.forEach(c=>{s.innerHTML+=`<option value="${c.id}">${c.number?'#'+c.number+' ':''}${c.name} (${getContainerPath(c.id)})</option>`;});
}

async function startScanner() {
    try { html5QrCode=new Html5Qrcode('scannerVideo'); await html5QrCode.start({facingMode:'environment'},{fps:10,qrbox:{width:250,height:250}},onScanSuccess,()=>{}); }
    catch(e) { document.getElementById('scanResult').innerHTML='<div style="color:red;padding:10px;">–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã.</div>'; }
}

function onScanSuccess(text) {
    if(text===lastScannedId) return;
    lastScannedId=text;
    const c=state.containers.find(x=>x.id===text);
    if(!c){document.getElementById('scanResult').innerHTML='<div style="color:orange;padding:10px;">QR –Ω–µ –∏–∑ SKLADITO</div>';setTimeout(()=>{lastScannedId=null;},2000);return;}
    if(scanMode==='look'){if(navigator.vibrate)navigator.vibrate(100);stopScanner();showScanResult(c);}
    else{const tid=document.getElementById('findTargetContainer').value;if(!tid){document.getElementById('scanResult').innerHTML='<div style="color:orange;padding:10px;">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä</div>';lastScannedId=null;return;}
    if(c.id===tid){if(navigator.vibrate)navigator.vibrate([100,50,200]);document.getElementById('scanResult').innerHTML=`<div style="background:#d4edda;color:#155724;padding:15px;border-radius:10px;text-align:center;"><div style="font-size:36px;">‚úÖ</div><div style="font-size:20px;font-weight:700;margin:10px 0;">–ù–ê–®–Å–õ!</div><div>#${c.number} ‚Äî ${c.name}</div></div>`;stopScanner();}
    else{document.getElementById('scanResult').innerHTML=`<div style="background:#fff3cd;color:#856404;padding:10px;border-radius:10px;text-align:center;">#${c.number} ${c.name} ‚Äî –Ω–µ —Ç–æ—Ç...</div>`;setTimeout(()=>{lastScannedId=null;},1000);}}
}

function showScanResult(c) {
    scanShowAllItems=false; lastScannedId=c.id;
    document.getElementById('scanResultTitle').textContent=`${c.number?'#'+c.number+' ':''}${c.name}`;
    renderScanContent(c.id,false);
    document.getElementById('toggleAllItems').textContent='üìã –ü–æ–∫–∞–∑–∞—Ç—å –í–°–ï –ø—Ä–µ–¥–º–µ—Ç—ã';
    openModal('scanResultModal');
}

function renderScanContent(cid, showAll) {
    const childC=state.containers.filter(c=>c.parent===cid), items=state.items.filter(i=>i.container===cid);
    let html='';
    if(showAll){const all=getAllItemsRecursive(cid);html+=`<div style="color:#4A90E2;font-weight:600;margin-bottom:10px;">–í—Å–µ–≥–æ: ${all.length}</div>`;all.forEach(i=>{const cat=state.categories.find(c=>c.id===i.category);html+=`<div style="padding:10px;border-bottom:1px solid #eee;display:flex;align-items:center;"><span style="font-size:20px;margin-right:10px;">${cat?cat.icon:'üìå'}</span><div style="flex:1;"><div style="font-weight:600;">${i.name} √ó${i.quantity}</div><div style="font-size:12px;color:#888;">üìç ${getContainerPath(i.container)}</div></div></div>`;});if(all.length===0)html+='<div style="text-align:center;color:#999;padding:20px;">–ü—É—Å—Ç–æ</div>';}
    else{if(childC.length>0){html+='<div style="font-weight:600;margin-bottom:8px;">üì¶ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:</div>';childC.forEach(c=>{const cnt=state.containers.filter(x=>x.parent===c.id).length+state.items.filter(i=>i.container===c.id).length;html+=`<div style="padding:10px;border-bottom:1px solid #eee;display:flex;align-items:center;"><span style="font-size:20px;margin-right:10px;">üì¶</span><div style="flex:1;"><span style="color:#4A90E2;margin-right:6px;">#${c.number||'?'}</span>${c.name}</div>${cnt>0?`<span style="background:#4A90E2;color:white;padding:2px 8px;border-radius:10px;font-size:12px;">${cnt}</span>`:''}</div>`;});}
    if(items.length>0){html+='<div style="font-weight:600;margin:12px 0 8px;">üìå –ü—Ä–µ–¥–º–µ—Ç—ã:</div>';items.forEach(i=>{const cat=state.categories.find(c=>c.id===i.category);html+=`<div style="padding:10px;border-bottom:1px solid #eee;display:flex;align-items:center;"><span style="font-size:20px;margin-right:10px;">${cat?cat.icon:'üìå'}</span><div style="flex:1;">${i.name}</div><span style="color:#999;">√ó${i.quantity}</span></div>`;});}
    if(childC.length===0&&items.length===0)html+='<div style="text-align:center;color:#999;padding:20px;">–ü—É—Å—Ç–æ</div>';}
    document.getElementById('scanResultContent').innerHTML=html;
}

function getAllItemsRecursive(cid) {
    let all=[...state.items.filter(i=>i.container===cid)];
    state.containers.filter(c=>c.parent===cid).forEach(ch=>{all=all.concat(getAllItemsRecursive(ch.id));});
    return all;
}

function toggleScanAllItems() {
    scanShowAllItems=!scanShowAllItems; renderScanContent(lastScannedId,scanShowAllItems);
    document.getElementById('toggleAllItems').textContent=scanShowAllItems?'üìÇ –¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å':'üìã –ü–æ–∫–∞–∑–∞—Ç—å –í–°–ï';
}

function navigateToScanned() { closeModal('scanResultModal'); if(lastScannedId)openContainer(lastScannedId); }

function stopScanner() {
    if(html5QrCode){html5QrCode.stop().then(()=>{html5QrCode.clear();html5QrCode=null;}).catch(()=>{});}
    closeModal('scannerModal');
}

// ==================== –°–ü–ò–°–û–ö –ü–û–ö–£–ü–û–ö ====================

function getShoppingItems() { return state.items.filter(i=>i.minQuantity>0&&i.quantity<i.minQuantity); }

function openShoppingList() {
    const items=getShoppingItems(); let html='';
    if(items.length===0){html='<div style="text-align:center;padding:30px;color:#999;"><div style="font-size:48px;margin-bottom:10px;">‚úÖ</div>–í—Å—ë –≤ –ø–æ—Ä—è–¥–∫–µ!</div>';}
    else{html+=`<div style="color:#dc3545;font-weight:600;margin-bottom:15px;">–ù—É–∂–Ω–æ –¥–æ–∫—É–ø–∏—Ç—å: ${items.length}</div>`;items.forEach(i=>{const cat=state.categories.find(c=>c.id===i.category);const need=i.minQuantity-i.quantity;const path=getContainerPath(i.container);const thumb=i.photo?`<img src="${i.photo}" style="width:40px;height:40px;border-radius:6px;object-fit:cover;margin-right:10px;">`:`<span style="font-size:24px;margin-right:10px;">${cat?cat.icon:'üìå'}</span>`;html+=`<div style="display:flex;align-items:center;padding:12px 0;border-bottom:1px solid #eee;">${thumb}<div style="flex:1;"><div style="font-weight:600;">${i.name}</div><div style="font-size:12px;color:#888;">üìç ${path}</div></div><div style="text-align:right;"><div style="color:#dc3545;font-weight:700;">+${need}</div><div style="font-size:11px;color:#999;">–µ—Å—Ç—å ${i.quantity}/${i.minQuantity}</div></div></div>`;});}
    document.getElementById('shoppingList').innerHTML=html; openModal('shoppingModal');
}

function shareShoppingList() {
    const items=getShoppingItems(); if(items.length===0){showToast('–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç!');return;}
    let text='üõí –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ SKLADITO:\n\n'; items.forEach(i=>{text+=`‚òê ${i.name} ‚Äî ${i.minQuantity-i.quantity} —à—Ç.\n`;}); text+=`\n–í—Å–µ–≥–æ: ${items.length}`;
    if(navigator.share){navigator.share({text}).catch(()=>{navigator.clipboard.writeText(text);showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!');});}else{navigator.clipboard.writeText(text);showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');}
}

function updateShoppingBadge() {
    const c=getShoppingItems().length; const b=document.getElementById('shoppingBadge');
    if(b){b.textContent=c>0?`‚ö†Ô∏è –ù—É–∂–Ω–æ –¥–æ–∫—É–ø–∏—Ç—å: ${c}`:'–í—Å—ë –≤ –ø–æ—Ä—è–¥–∫–µ';b.style.color=c>0?'#dc3545':'';}
}

// ==================== –°–ü–ò–°–ê–ù–ò–ï ====================

let writeOffTargetItem=null;

function openWriteOff() {
    document.getElementById('writeOffSearch').value='';
    document.getElementById('writeOffResults').innerHTML='<div style="text-align:center;color:#999;padding:20px;">–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</div>';
    openModal('writeOffModal'); document.getElementById('writeOffSearch').focus();
}

function searchWriteOff() {
    const q=document.getElementById('writeOffSearch').value.toLowerCase().trim();
    const r=document.getElementById('writeOffResults');
    if(q.length<1){r.innerHTML='<div style="text-align:center;color:#999;padding:20px;">–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</div>';return;}
    const found=state.items.filter(i=>i.name.toLowerCase().includes(q));
    if(found.length===0){r.innerHTML='<div style="text-align:center;color:#999;padding:20px;">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>';return;}
    let html=''; found.forEach(i=>{const cat=state.categories.find(c=>c.id===i.category);const path=getContainerPath(i.container);const thumb=i.photo?`<img src="${i.photo}" style="width:40px;height:40px;border-radius:6px;object-fit:cover;margin-right:10px;">`:`<span style="font-size:24px;margin-right:10px;">${cat?cat.icon:'üìå'}</span>`;
    html+=`<div style="display:flex;align-items:center;padding:12px;border-bottom:1px solid #eee;cursor:pointer;border-radius:8px;" onclick="selectWriteOff('${i.id}')">${thumb}<div style="flex:1;"><div style="font-weight:600;">${i.name}</div><div style="font-size:12px;color:#888;">üìç ${path}</div></div><div style="font-weight:700;color:#4A90E2;">√ó${i.quantity}</div></div>`;});
    r.innerHTML=html;
}

function selectWriteOff(itemId) {
    const item=state.items.find(i=>i.id===itemId); if(!item)return;
    writeOffTargetItem=item;
    const cat=state.categories.find(c=>c.id===item.category); const path=getContainerPath(item.container);
    document.getElementById('writeOffConfirmContent').innerHTML=`<div style="text-align:center;padding:10px 0;">${item.photo?`<img src="${item.photo}" style="width:80px;height:80px;border-radius:10px;object-fit:cover;margin-bottom:10px;">`:`<div style="font-size:48px;margin-bottom:10px;">${cat?cat.icon:'üìå'}</div>`}<div style="font-size:20px;font-weight:700;">${item.name}</div><div style="font-size:14px;color:#888;margin-top:5px;">üìç ${path}</div><div style="margin-top:10px;"><span style="font-size:28px;font-weight:700;color:#4A90E2;">√ó${item.quantity}</span>${item.minQuantity>0?`<span style="font-size:14px;color:#999;"> (–º–∏–Ω: ${item.minQuantity})</span>`:''}</div></div>`;
    document.getElementById('writeOffAmount').value=1; document.getElementById('writeOffAmount').max=item.quantity;
    openModal('writeOffConfirmModal');
}

async function confirmWriteOff() {
    if(!writeOffTargetItem)return;
    const amount=parseInt(document.getElementById('writeOffAmount').value)||1;
    if(amount>writeOffTargetItem.quantity){showToast('–ù–µ–ª—å–∑—è —Å–ø–∏—Å–∞—Ç—å –±–æ–ª—å—à–µ!');return;}
    writeOffTargetItem.quantity-=amount;
    try {
        await fetch(`${API_BASE}/items/${writeOffTargetItem.id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(writeOffTargetItem) });
        await loadData();
        const belowMin=writeOffTargetItem.minQuantity>0&&writeOffTargetItem.quantity<writeOffTargetItem.minQuantity;
        closeModal('writeOffConfirmModal'); closeModal('writeOffModal');
        showToast(belowMin?`–°–ø–∏—Å–∞–Ω–æ ${amount}. ‚ö†Ô∏è –ù—É–∂–Ω–æ –¥–æ–∫—É–ø–∏—Ç—å!`:`–°–ø–∏—Å–∞–Ω–æ ${amount}. –û—Å—Ç–∞–ª–æ—Å—å: ${writeOffTargetItem.quantity}`);
        writeOffTargetItem=null;
        if(state.viewMode==='container')openContainer(state.currentContainer); else renderMain();
    } catch(e) { alert('–û—à–∏–±–∫–∞: '+e.message); }
}

init();
    </script>
</body>
</html>
