<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>SKLADITO v2.8.9</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Roboto', 'Segoe UI', sans-serif;
    background: #F5F5F5;
    color: #333;
    padding-bottom: 200px;
}

.header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    position: sticky;
    top: 0;
    z-index: 100;
}

.header-content {
    display: flex;
    align-items: center;
}

.back-btn {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 5px 10px;
    margin-right: 10px;
}

.burger-btn {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 5px 10px;
}

.header-tokens {
    background: rgba(255,255,255,0.2);
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    margin-left: auto;
    margin-right: 10px;
    transition: background 0.2s;
}

.header-tokens:active {
    background: rgba(255,255,255,0.3);
}

.header-title {
    flex: 1;
}

.header h1 {
    font-size: 22px;
    font-weight: 600;
}

.burger-menu {
    position: fixed;
    top: 0;
    right: -100%;
    width: 280px;
    height: 100vh;
    background: white;
    box-shadow: -2px 0 10px rgba(0,0,0,0.2);
    z-index: 200;
    transition: right 0.3s;
    overflow-y: auto;
}

.burger-menu.active {
    right: 0;
}

.burger-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 199;
    display: none;
}

.burger-overlay.active {
    display: block;
}

.burger-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
}

.burger-header h2 {
    font-size: 20px;
    margin-bottom: 5px;
}

.burger-header p {
    font-size: 12px;
    opacity: 0.9;
}

.burger-content {
    padding: 20px;
}

.burger-item {
    padding: 15px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
}

.burger-item:active {
    background: #f5f5f5;
}

.burger-item-icon {
    font-size: 24px;
}

.burger-item-text {
    flex: 1;
}

.burger-item-title {
    font-weight: 600;
    font-size: 16px;
}

.burger-item-subtitle {
    font-size: 12px;
    color: #666;
    margin-top: 2px;
}

.storage-indicator {
    background: #f5f5f5;
    padding: 12px 15px;
    margin: 15px 0;
    border-radius: 8px;
}

.storage-bar {
    height: 6px;
    background: #e0e0e0;
    border-radius: 3px;
    overflow: hidden;
    margin-top: 8px;
}

.storage-fill {
    height: 100%;
    background: #667eea;
    transition: width 0.3s, background 0.3s;
}

.storage-fill.warning {
    background: #ff9800;
}

.storage-fill.danger {
    background: #f44336;
}

/* ONBOARDING */
.onboarding {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    z-index: 1000;
    display: flex;
    flex-direction: column;
}

.onboarding-slides {
    flex: 1;
    display: flex;
    overflow: hidden;
    position: relative;
}

.onboarding-slide {
    min-width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px 30px;
    text-align: center;
    color: white;
    transition: transform 0.3s ease;
}

.onboarding-icon {
    font-size: 80px;
    margin-bottom: 30px;
}

.onboarding-title {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 20px;
    line-height: 1.3;
}

.onboarding-text {
    font-size: 18px;
    opacity: 0.9;
    line-height: 1.6;
    max-width: 320px;
}

.onboarding-footer {
    padding: 30px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
}

.onboarding-dots {
    display: flex;
    gap: 10px;
}

.onboarding-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: rgba(255,255,255,0.4);
    transition: background 0.3s, transform 0.3s;
}

.onboarding-dot.active {
    background: white;
    transform: scale(1.2);
}

.onboarding-btn {
    background: white;
    color: #667eea;
    border: none;
    padding: 16px 60px;
    border-radius: 30px;
    font-size: 18px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}

.onboarding-btn:active {
    transform: scale(0.95);
}

.onboarding-skip {
    background: none;
    border: none;
    color: rgba(255,255,255,0.7);
    font-size: 14px;
    cursor: pointer;
    padding: 10px;
}

.container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #999;
}

.empty-state-icon {
    font-size: 64px;
    margin-bottom: 15px;
}

.empty-state-text {
    font-size: 18px;
    margin-bottom: 20px;
}

.card {
    background: white;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: transform 0.2s;
}

.card:active {
    transform: scale(0.98);
}

.card-header {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.card-icon {
    font-size: 32px;
    margin-right: 12px;
    flex-shrink: 0;
}

.card-thumb {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    object-fit: cover;
    margin-right: 12px;
    flex-shrink: 0;
}

.card-title {
    flex: 1;
    font-size: 18px;
    font-weight: 600;
}

.card-badge {
    background: #667eea;
    color: white;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

.card-info {
    color: #666;
    font-size: 14px;
    margin-top: 5px;
}

.card-photo {
    width: 100%;
    max-height: 200px;
    object-fit: cover;
    border-radius: 8px;
    margin-top: 10px;
}

.btn {
    background: #667eea;
    color: white;
    border: none;
    padding: 14px 24px;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
    margin-top: 10px;
    transition: background 0.2s;
}

.btn:active {
    background: #764ba2;
}

.btn-secondary {
    background: #6c757d;
}

.btn-danger {
    background: #dc3545;
}

.btn-small {
    padding: 8px 16px;
    font-size: 14px;
    width: auto;
    display: inline-block;
    margin: 5px;
}

.action-bar {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.action-bar .action-btn {
    flex: 1;
    padding: 14px;
    border: none;
    border-radius: 12px;
    font-size: 22px;
    cursor: pointer;
    text-align: center;
    transition: transform 0.15s;
}

.action-bar .action-btn:active {
    transform: scale(0.93);
}

.action-btn-save {
    background: #667eea;
    color: white;
}

.action-btn-delete {
    background: #dc3545;
    color: white;
}

.action-btn-cancel {
    background: #e9ecef;
    color: #333;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    padding: 20px;
    overflow-y: auto;
}

.modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: 16px;
    padding: 24px;
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    font-size: 14px;
}

.form-input {
    width: 100%;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
}

.form-input:focus {
    outline: none;
    border-color: #667eea;
}

.form-select {
    width: 100%;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
    background: white;
}

.search-bar {
    position: relative;
    margin-bottom: 20px;
}

.search-input {
    width: 100%;
    padding: 12px 40px 12px 12px;
    border: 2px solid #ddd;
    border-radius: 12px;
    font-size: 16px;
}

.search-icon {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 20px;
    color: #999;
}

.fab {
    position: fixed;
    bottom: 80px;
    right: 20px;
    width: 56px;
    height: 56px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 24px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    cursor: pointer;
    z-index: 100;
}

.fab-scan {
    position: fixed;
    bottom: 80px;
    left: 20px;
    width: 56px;
    height: 56px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 24px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    cursor: pointer;
    z-index: 100;
}

.fab:active {
    transform: scale(0.95);
}

.fab-menu {
    position: fixed;
    bottom: 150px;
    right: 20px;
    z-index: 99;
    display: none;
}

.fab-menu.active {
    display: block;
}

.fab-menu-item {
    background: white;
    padding: 12px 20px;
    margin-bottom: 10px;
    border-radius: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    cursor: pointer;
    white-space: nowrap;
    transition: transform 0.2s;
}

.fab-menu-item:active {
    transform: scale(0.95);
}

.category-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
}

.category-card {
    background: white;
    padding: 16px;
    border-radius: 12px;
    text-align: center;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    transition: transform 0.2s;
}

.category-card:active {
    transform: scale(0.95);
}

.category-icon {
    font-size: 40px;
    margin-bottom: 8px;
}

.category-name {
    font-size: 14px;
    font-weight: 600;
}

.photo-preview {
    width: 100%;
    max-height: 300px;
    object-fit: cover;
    border-radius: 8px;
    margin-top: 10px;
}

.photo-upload {
    display: none;
}

.photo-upload-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 12px;
    border: 2px dashed #ddd;
    border-radius: 8px;
    cursor: pointer;
    color: #666;
    transition: all 0.2s;
    margin-top: 10px;
}

.photo-upload-btn:hover {
    border-color: #667eea;
    color: #667eea;
}

.photo-actions {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.alert {
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 16px;
}

.alert-success {
    background: #d4edda;
    color: #155724;
}

.alert-error {
    background: #f8d7da;
    color: #721c24;
}

.alert-warning {
    background: #fff3cd;
    color: #856404;
}

/* TOAST */
.toast {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: #333;
    color: white;
    padding: 12px 24px;
    border-radius: 24px;
    font-size: 14px;
    opacity: 0;
    transition: all 0.3s;
    z-index: 3000;
    max-width: 90%;
    text-align: center;
}

.toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}

/* QR –ö–ê–†–¢–û–ß–ö–ê –î–õ–Ø –ü–ï–ß–ê–¢–ò */
.qr-print-card {
    text-align: center;
    padding: 20px;
    border: 2px dashed #ccc;
    border-radius: 12px;
    margin-bottom: 20px;
}

.qr-print-card .qr-number {
    font-size: 48px;
    font-weight: 800;
    color: #333;
    margin-top: 12px;
    letter-spacing: 4px;
    font-family: 'Courier New', monospace;
}

.qr-print-card .qr-name {
    font-size: 14px;
    color: #888;
    margin-top: 8px;
}

.qr-code-wrapper {
    display: inline-block;
    padding: 10px;
    background: white;
}

/* –°–ö–ê–ù–ï–† */
.scanner-container {
    position: relative;
    width: 100%;
    max-width: 400px;
    margin: 0 auto;
}

#scannerView {
    width: 100%;
    border-radius: 12px;
    overflow: hidden;
}

.scanner-mode-toggle {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
}

.scanner-mode-btn {
    flex: 1;
    padding: 10px;
    border: 2px solid #667eea;
    border-radius: 10px;
    background: white;
    color: #667eea;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    text-align: center;
}

.scanner-mode-btn.active {
    background: #667eea;
    color: white;
}

.scanner-search-target {
    background: #f0f0ff;
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 16px;
}

.scanner-found {
    background: #d4edda;
    padding: 16px;
    border-radius: 12px;
    text-align: center;
    margin-top: 16px;
}

.scanner-found .found-icon {
    font-size: 48px;
}

.scanner-found .found-text {
    font-size: 18px;
    font-weight: 600;
    margin-top: 8px;
}

.scan-result-list {
    margin-top: 16px;
}

.all-items-toggle {
    background: #f0f0ff;
    border: 2px solid #667eea;
    border-radius: 10px;
    padding: 10px;
    width: 100%;
    font-size: 14px;
    font-weight: 600;
    color: #667eea;
    cursor: pointer;
    margin-top: 12px;
}

@media print {
    body * { visibility: hidden; }
    .qr-print-area, .qr-print-area * { visibility: visible; }
    .qr-print-area {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
    }
}

/* ONBOARDING */
.onboarding {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    z-index: 2000;
    color: white;
    overflow: hidden;
}

.onboarding.active {
    display: flex;
    flex-direction: column;
}

.onboarding-slides {
    flex: 1;
    display: flex;
    overflow-x: hidden;
    scroll-snap-type: x mandatory;
}

.onboarding-slide {
    min-width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px 30px;
    text-align: center;
    scroll-snap-align: start;
}

.onboarding-icon {
    font-size: 80px;
    margin-bottom: 30px;
}

.onboarding-title {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 20px;
    line-height: 1.3;
}

.onboarding-text {
    font-size: 18px;
    opacity: 0.9;
    line-height: 1.6;
    max-width: 320px;
}

.onboarding-nav {
    padding: 30px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
}

.onboarding-dots {
    display: flex;
    gap: 10px;
}

.onboarding-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: rgba(255,255,255,0.4);
    transition: all 0.3s;
}

.onboarding-dot.active {
    background: white;
    width: 24px;
    border-radius: 5px;
}

.onboarding-btn {
    background: white;
    color: #667eea;
    border: none;
    padding: 16px 48px;
    border-radius: 30px;
    font-size: 18px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s;
}

.onboarding-btn:active {
    transform: scale(0.95);
}

.onboarding-skip {
    background: none;
    border: none;
    color: rgba(255,255,255,0.7);
    font-size: 14px;
    cursor: pointer;
    padding: 10px;
}

    </style>
</head>
<body>
    <!-- ONBOARDING -->
    <div class="onboarding" id="onboarding">
        <div class="onboarding-slides" id="onboardingSlides">
            <div class="onboarding-slide">
                <div class="onboarding-icon">üì¶</div>
                <div class="onboarding-title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ SKLADITO</div>
                <div class="onboarding-text">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É—á—ë—Ç–∞ –≤–µ—â–µ–π, —Ä–∞–∑–±—Ä–æ—Å–∞–Ω–Ω—ã—Ö –ø–æ —Ä–∞–∑–Ω—ã–º –º–µ—Å—Ç–∞–º —Ö—Ä–∞–Ω–µ–Ω–∏—è</div>
            </div>
            <div class="onboarding-slide">
                <div class="onboarding-icon">üóÑÔ∏è</div>
                <div class="onboarding-title">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã</div>
                <div class="onboarding-text">–ö–æ–º–Ω–∞—Ç—ã, —à–∫–∞—Ñ—ã, –ø–æ–ª–∫–∏, –∫–æ—Ä–æ–±–∫–∏ ‚Äî –ª—é–±–∞—è –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å. –ö–∞–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏</div>
            </div>
            <div class="onboarding-slide">
                <div class="onboarding-icon">üîç</div>
                <div class="onboarding-title">–ù–∞—Ö–æ–¥–∏—Ç–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ</div>
                <div class="onboarding-text">–ó–∞–±—ã–ª–∏ –≥–¥–µ –ª–µ–∂–∏—Ç –≤–µ—â—å? –ü–æ–∏—Å–∫ –ø–æ–∫–∞–∂–µ—Ç —Ç–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</div>
            </div>
            <div class="onboarding-slide">
                <div class="onboarding-icon">üîÑ</div>
                <div class="onboarding-title">–°–ª–µ–¥–∏—Ç–µ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏</div>
                <div class="onboarding-text">–í–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —É–∫–∞–∑–∞–Ω–∞ –≤ —à–∞–ø–∫–µ. –ï—Å–ª–∏ –æ–Ω–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å ‚Äî –∏—â–∏—Ç–µ –Ω–æ–≤—ã–µ –ø–æ–ª–µ–∑–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏!</div>
            </div>
        </div>
        <div class="onboarding-nav">
            <div class="onboarding-dots">
                <div class="onboarding-dot active" data-slide="0"></div>
                <div class="onboarding-dot" data-slide="1"></div>
                <div class="onboarding-dot" data-slide="2"></div>
                <div class="onboarding-dot" data-slide="3"></div>
            </div>
            <button class="onboarding-btn" id="onboardingBtn">–î–∞–ª–µ–µ</button>
            <button class="onboarding-skip" id="onboardingSkip">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
        </div>
    </div>
    <div class="header">
        <div class="header-content">
            <button class="back-btn" id="backBtn" style="display:none;">‚Üê</button>
            <div class="header-title" onclick="renderMain()" style="cursor:pointer;">
                <h1>üì¶ SKLADITO Phone v2.8.9</h1>
            </div>
            <span class="header-tokens" id="headerTokens" onclick="openTokensModal()">üí∞ <span id="tokenCount">10</span></span>
            <button class="burger-btn" id="burgerBtn">‚ò∞</button>
        </div>
    </div>

    <!-- –ë–£–†–ì–ï–†-–ú–ï–ù–Æ -->
    <div class="burger-overlay" id="burgerOverlay" onclick="closeBurgerMenu()"></div>
    <div class="burger-menu" id="burgerMenu">
        <div class="burger-header">
            <h2>üì¶ SKLADITO Phone v2.8.9</h2>
            <p>–õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ</p>
        </div>
        <div class="burger-content">
            <div class="storage-indicator">
                <div style="font-size:14px;margin-bottom:5px;">–•—Ä–∞–Ω–∏–ª–∏—â–µ: <strong id="burgerStorageUsed">0 –ú–ë</strong></div>
                <div class="storage-bar">
                    <div class="storage-fill" id="burgerStorageFill"></div>
                </div>
            </div>

            <div class="burger-item" onclick="exportData(); closeBurgerMenu();">
                <div class="burger-item-icon">üì§</div>
                <div class="burger-item-text">
                    <div class="burger-item-title">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</div>
                    <div class="burger-item-subtitle">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é</div>
                </div>
            </div>

            <div class="burger-item" onclick="document.getElementById('importFile').click(); closeBurgerMenu();">
                <div class="burger-item-icon">üì•</div>
                <div class="burger-item-text">
                    <div class="burger-item-title">–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</div>
                    <div class="burger-item-subtitle">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –∫–æ–ø–∏–∏</div>
                </div>
            </div>

            <div class="burger-item" onclick="openCategoriesModal(); closeBurgerMenu();">
                <div class="burger-item-icon">üè∑Ô∏è</div>
                <div class="burger-item-text">
                    <div class="burger-item-title">–ü—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–π</div>
                    <div class="burger-item-subtitle">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>
                </div>
            </div>

            <div class="burger-item" onclick="openShoppingList(); closeBurgerMenu();">
                <div class="burger-item-icon">üõí</div>
                <div class="burger-item-text">
                    <div class="burger-item-title">–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</div>
                    <div class="burger-item-subtitle" id="shoppingBadge">–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–∫—É–ø–∏—Ç—å</div>
                </div>
            </div>

            <div class="burger-item" onclick="openWriteOff(); closeBurgerMenu();">
                <div class="burger-item-icon">üìù</div>
                <div class="burger-item-text">
                    <div class="burger-item-title">–°–ø–∏—Å–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç</div>
                    <div class="burger-item-subtitle">–£–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
                </div>
            </div>

            <div class="burger-item" onclick="showOnboarding(); closeBurgerMenu();">
                <div class="burger-item-icon">‚ùì</div>
                <div class="burger-item-text">
                    <div class="burger-item-title">–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</div>
                    <div class="burger-item-subtitle">–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è</div>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData(event)">

    <div class="container">
        <div id="breadcrumbsBar" style="display:none;padding:8px 0;font-size:13px;color:#666;">
            <span id="breadcrumbs"></span>
        </div>
        <div id="searchContainer" style="display:none;">
            <div class="search-bar">
                <input type="text" class="search-input" id="searchInput" placeholder="–ü–æ–∏—Å–∫...">
                <span class="search-icon">üîç</span>
            </div>
        </div>

        <div id="mainContent">
            <div class="empty-state">
                <div class="empty-state-icon">üì¶</div>
                <div class="empty-state-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>

    <button class="fab" id="fabBtn" style="display:none;">+</button>
    <button class="fab-scan" id="scanFabBtn" onclick="openScannerModal()">üì∑</button>
    
    <div class="fab-menu" id="fabMenu">
        <div class="fab-menu-item" onclick="openAddContainerModal()">üì¶ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä</div>
        <div class="fab-menu-item" onclick="openAddItemModal()">üìå –ü—Ä–µ–¥–º–µ—Ç</div>
        <div class="fab-menu-item" onclick="openScannerModal()">üì∑ –°–∫–∞–Ω–µ—Ä QR</div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ö–û–ù–¢–ï–ô–ù–ï–†–ê -->
    <div class="modal" id="addContainerModal">
        <div class="modal-content">
            <div class="modal-header">–ù–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä</div>
            <form id="addContainerForm">
                <div class="form-group">
                    <label class="form-label">–ù–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞</label>
                    <input type="text" class="form-input" id="containerNumber" maxlength="4" pattern="[0-9]{1,4}" style="font-size:24px;text-align:center;font-weight:700;letter-spacing:4px;font-family:'Courier New',monospace;">
                    <div style="font-size:12px;color:#888;margin-top:4px;">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å.</div>
                </div>
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                    <input type="text" class="form-input" id="containerName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–§–æ—Ç–æ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ 500 –ö–ë)</label>
                    <input type="file" class="photo-upload" id="containerPhoto" accept="image/*">
                    <div class="photo-upload-btn" onclick="document.getElementById('containerPhoto').click()">
                        üì∑ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
                    </div>
                    <img id="containerPhotoPreview" class="photo-preview" style="display:none;">
                </div>
                <div class="action-bar">
                    <button type="submit" class="action-btn action-btn-save">‚úì</button>
                    <button type="button" class="action-btn action-btn-cancel" onclick="closeModal('addContainerModal')">‚úï</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ü–†–ï–î–ú–ï–¢–ê -->
    <div class="modal" id="addItemModal">
        <div class="modal-content">
            <div class="modal-header">–ù–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç</div>
            <form id="addItemForm">
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                    <input type="text" class="form-input" id="itemName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
                    <input type="number" class="form-input" id="itemQuantity" min="0" value="1" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–ú–∏–Ω. –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ <span style="color:#999;font-weight:400;">(–¥–ª—è —Å–ø–∏—Å–∫–∞ –ø–æ–∫—É–ø–æ–∫)</span></label>
                    <input type="number" class="form-input" id="itemMinQuantity" min="0" value="0">
                </div>
                <div class="form-group">
                    <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <div style="display:flex;gap:8px;">
                        <select class="form-select" id="itemCategory" style="flex:1;">
                            <option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                        </select>
                        <button type="button" class="btn btn-small" onclick="showNewCategoryInput('item')" style="width:auto;padding:10px 14px;margin:0;white-space:nowrap;">+ –ù–æ–≤–∞—è</button>
                    </div>
                    <div id="newCategoryItem" style="display:none;margin-top:8px;">
                        <div style="display:flex;gap:8px;">
                            <input type="text" class="form-input" id="newCategoryNameItem" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" style="flex:1;">
                            <button type="button" class="btn btn-small" onclick="addNewCategory('item')" style="width:auto;padding:10px 14px;margin:0;">‚úì</button>
                            <button type="button" class="btn btn-small btn-secondary" onclick="hideNewCategoryInput('item')" style="width:auto;padding:10px 14px;margin:0;">‚úï</button>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">–§–æ—Ç–æ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ 500 –ö–ë)</label>
                    <input type="file" class="photo-upload" id="itemPhoto" accept="image/*">
                    <div class="photo-upload-btn" onclick="document.getElementById('itemPhoto').click()">
                        üì∑ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
                    </div>
                    <img id="itemPhotoPreview" class="photo-preview" style="display:none;">
                </div>
                <div class="action-bar">
                    <button type="submit" class="action-btn action-btn-save">‚úì</button>
                    <button type="button" class="action-btn action-btn-cancel" onclick="closeModal('addItemModal')">‚úï</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –ö–ê–¢–ï–ì–û–†–ò–ô -->
    <div class="modal" id="categoriesModal">
        <div class="modal-content">
            <div class="modal-header">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
            <div id="categoriesList"></div>
            <div style="margin-top:15px;">
                <div style="display:flex;gap:8px;">
                    <input type="text" class="form-input" id="newCategoryNameModal" placeholder="–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è">
                    <button class="btn btn-small" onclick="addCategoryFromModal()" style="width:auto;padding:10px 14px;margin:0;">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="closeModal('categoriesModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header" id="editModalTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
            <form id="editForm">
                <div id="editFormContent"></div>
                <div class="action-bar">
                    <button type="submit" class="action-btn action-btn-save">‚úì</button>
                    <button type="button" class="action-btn action-btn-delete" id="deleteBtn">üóëÔ∏è</button>
                    <button type="button" class="action-btn action-btn-cancel" onclick="closeModal('editModal')">‚úï</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –¢–û–ö–ï–ù–û–í -->
    <div class="modal" id="tokensModal">
        <div class="modal-content">
            <div class="modal-header">üí∞ –¢–æ–∫–µ–Ω—ã</div>
            
            <!-- –ë–∞–ª–∞–Ω—Å -->
            <div style="text-align:center;padding:20px 0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:12px;color:white;margin-bottom:20px;">
                <div style="font-size:48px">üí∞</div>
                <div style="font-size:42px;font-weight:700" id="modalTokenCount">10</div>
                <div style="opacity:0.9">—Ç–æ–∫–µ–Ω–æ–≤</div>
            </div>
            
            <!-- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ -->
            <div style="background:#f0f0ff;padding:16px;border-radius:12px;margin-bottom:20px">
                <div style="font-weight:600;margin-bottom:8px">üéÅ –ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞!</div>
                <div style="font-size:13px;color:#666">
                    –ü–æ–¥–µ–ª–∏—Å—å –∫–æ–¥–æ–º ‚Äî –≤—ã –æ–±–∞ –ø–æ–ª—É—á–∏—Ç–µ –ø–æ <strong>5 —Ç–æ–∫–µ–Ω–æ–≤</strong>!
                </div>
            </div>
            
            <!-- –ú–æ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ -->
            <div class="form-group">
                <label class="form-label">–¢–≤–æ–π –∫–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</label>
                <div style="display:flex;gap:10px">
                    <input type="text" class="form-input" id="myRefCode" readonly style="font-weight:600;text-align:center;font-size:18px;letter-spacing:2px">
                    <button type="button" class="btn" style="width:auto;padding:12px 20px" onclick="shareRefCode()">üì§</button>
                </div>
                <div style="font-size:12px;color:#888;margin-top:6px" id="refStats">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            
            <hr style="margin:20px 0;border:none;border-top:1px solid #eee">
            
            <!-- –í–≤–æ–¥ –∫–æ–¥–∞ -->
            <div class="form-group">
                <label class="form-label">–í–≤–µ—Å—Ç–∏ –ø—Ä–æ–º–æ–∫–æ–¥ –∏–ª–∏ –∫–æ–¥ –¥—Ä—É–≥–∞</label>
                <div style="display:flex;gap:10px">
                    <input type="text" class="form-input" id="promoCodeInput" placeholder="–í–í–ï–î–ò–¢–ï –ö–û–î" style="text-transform:uppercase">
                    <button type="button" class="btn" style="width:auto;padding:12px 20px" onclick="applyCode()">OK</button>
                </div>
            </div>
            
            <button class="btn btn-secondary" onclick="closeModal('tokensModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê QR-–ö–û–î–ê -->
    <div class="modal" id="qrModal">
        <div class="modal-content">
            <div class="modal-header">QR-–∫–æ–¥ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞</div>
            <div class="qr-print-area">
                <div class="qr-print-card">
                    <div class="qr-code-wrapper" id="qrCodeContainer"></div>
                    <div class="qr-number" id="qrNumber"></div>
                    <div class="qr-name" id="qrName"></div>
                </div>
            </div>
            <button class="btn" onclick="printQR()">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
            <button class="btn btn-secondary" onclick="closeQrModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –°–ö–ê–ù–ï–†–ê -->
    <div class="modal" id="scannerModal">
        <div class="modal-content">
            <div class="modal-header">üì∑ –°–∫–∞–Ω–µ—Ä QR</div>
            <div class="scanner-mode-toggle">
                <button class="scanner-mode-btn active" id="scanModeWhat" onclick="setScanMode('what')">üîç –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏?</button>
                <button class="scanner-mode-btn" id="scanModeFind" onclick="setScanMode('find')">üéØ –ù–∞–π—Ç–∏ –∫–æ—Ä–æ–±–∫—É</button>
            </div>
            <div id="scanFindTarget" class="scanner-search-target" style="display:none;">
                <label class="form-label">–ö–∞–∫–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏—â–µ–º?</label>
                <select class="form-select" id="scanTargetSelect" onchange="updateScanTarget()">
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                </select>
            </div>
            <div class="scanner-container">
                <div id="scannerView"></div>
            </div>
            <div id="scanResult"></div>
            <button class="btn btn-secondary" style="margin-top:16px;" onclick="closeScannerModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –°–ü–ò–°–û–ö –ü–û–ö–£–ü–û–ö -->
    <div class="modal" id="shoppingModal">
        <div class="modal-content">
            <div class="modal-header">üõí –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</div>
            <div id="shoppingList"></div>
            <button class="btn" onclick="shareShoppingList()" style="margin-top:15px;">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å–ø–∏—Å–∫–æ–º</button>
            <button class="btn btn-secondary" onclick="closeModal('shoppingModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –°–ü–ò–°–ê–ù–ò–Ø -->
    <div class="modal" id="writeOffModal">
        <div class="modal-content">
            <div class="modal-header">üìù –°–ø–∏—Å–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç</div>
            <div class="form-group">
                <label class="form-label">–ü–æ–∏—Å–∫ –ø—Ä–µ–¥–º–µ—Ç–∞</label>
                <input type="text" class="form-input" id="writeOffSearch" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ..." oninput="searchWriteOff()">
            </div>
            <div id="writeOffResults" style="max-height:400px;overflow-y:auto;"></div>
            <button class="btn btn-secondary" onclick="closeModal('writeOffModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø –°–ü–ò–°–ê–ù–ò–Ø -->
    <div class="modal" id="writeOffConfirmModal">
        <div class="modal-content">
            <div class="modal-header">–°–ø–∏—Å–∞—Ç—å?</div>
            <div id="writeOffConfirmContent"></div>
            <div class="form-group" style="margin-top:15px;">
                <label class="form-label">–°–∫–æ–ª—å–∫–æ —Å–ø–∏—Å–∞—Ç—å?</label>
                <input type="number" class="form-input" id="writeOffAmount" min="1" value="1" style="width:100px;text-align:center;font-size:24px;font-weight:700;">
            </div>
            <button class="btn btn-danger" onclick="confirmWriteOff()">–°–ø–∏—Å–∞—Ç—å</button>
            <button class="btn btn-secondary" onclick="closeModal('writeOffConfirmModal')">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <script>
// –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
let state = {
    containers: [],
    items: [],
    categories: [],
    currentContainer: null,
    viewMode: 'main',
    editingObject: null
};

// –ü–†–ï–î–£–°–¢–ê–ù–û–í–õ–ï–ù–ù–´–ï –ö–ê–¢–ï–ì–û–†–ò–ò
const DEFAULT_CATEGORIES = [
    { id: 'cat1', name: '–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã', icon: 'üîß', order: 0 },
    { id: 'cat2', name: '–ö–∞–Ω—Ü–µ–ª—è—Ä–∏—è', icon: 'üìù', order: 1 },
    { id: 'cat3', name: '–ë—ã—Ç–æ–≤—ã–µ –≤–µ—â–∏', icon: 'üè†', order: 2 },
    { id: 'cat4', name: '–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞', icon: '‚ö°', order: 3 },
    { id: 'cat5', name: '–û–¥–µ–∂–¥–∞', icon: 'üëï', order: 4 }
];

// ==================== –¢–û–ö–ï–ù–´ –ò –†–ï–§–ï–†–ê–õ–¨–ù–ê–Ø –°–ò–°–¢–ï–ú–ê ====================

// –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏ –Ω–∞ URL —Ç–≤–æ–µ–≥–æ Cloudflare Worker!
const API_URL = 'https://skladito-api.camenadoo.workers.dev';

// –ü–æ–ª—É—á–∏—Ç—å User ID (—Å–æ–∑–¥–∞—ë—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑)
function getUserId() {
    let id = localStorage.getItem('skladito_user_id');
    if (!id) {
        id = 'user-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('skladito_user_id', id);
    }
    return id;
}

// –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω—ã
function getTokens() {
    return parseInt(localStorage.getItem('skladito_tokens')) || 10;
}

// –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω—ã
function setTokens(n) {
    localStorage.setItem('skladito_tokens', n);
    updateTokensDisplay();
}

// –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
function updateTokensDisplay() {
    const tokens = getTokens();
    document.getElementById('tokenCount').textContent = tokens;
    const modalCount = document.getElementById('modalTokenCount');
    if (modalCount) modalCount.textContent = tokens;
}

// –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É —Ç–æ–∫–µ–Ω–æ–≤
function openTokensModal() {
    updateTokensDisplay();
    openModal('tokensModal');
    loadMyRefCode();
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥
async function loadMyRefCode() {
    const userId = getUserId();
    const refCodeInput = document.getElementById('myRefCode');
    const refStats = document.getElementById('refStats');
    
    try {
        const response = await fetch(`${API_URL}/ref/get?user=${userId}`);
        const data = await response.json();
        
        if (data.code) {
            refCodeInput.value = data.code;
            refStats.textContent = `–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ: ${data.referrals} ‚Ä¢ –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: ${data.earnedTokens} —Ç–æ–∫–µ–Ω–æ–≤`;
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã
            const syncResp = await fetch(`${API_URL}/ref/sync?user=${userId}`);
            const syncData = await syncResp.json();
            if (syncData.earnedTokens > 0) {
                setTokens(getTokens() + syncData.earnedTokens);
                showToast(`+${syncData.earnedTokens} —Ç–æ–∫–µ–Ω–æ–≤ –æ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤!`);
            }
        }
    } catch (err) {
        refStats.textContent = '–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É';
        console.error('Ref code error:', err);
    }
}

// –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ–¥ (–ø—Ä–æ–º–æ–∫–æ–¥ –∏–ª–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π)
async function applyCode() {
    const input = document.getElementById('promoCodeInput');
    const code = input.value.trim().toUpperCase();
    
    if (!code) {
        showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥');
        return;
    }
    
    const userId = getUserId();
    
    try {
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∫–∞–∫ –ø—Ä–æ–º–æ–∫–æ–¥
        let response = await fetch(`${API_URL}/code/check?code=${code}&user=${userId}`);
        let data = await response.json();
        
        if (data.success) {
            setTokens(getTokens() + data.tokens);
            showToast(`+${data.tokens} —Ç–æ–∫–µ–Ω–æ–≤!`);
            input.value = '';
            return;
        }
        
        // –ï—Å–ª–∏ –Ω–µ –ø—Ä–æ–º–æ–∫–æ–¥ ‚Äî –ø—Ä–æ–±—É–µ–º –∫–∞–∫ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥
        response = await fetch(`${API_URL}/ref/use?code=${code}&user=${userId}`);
        data = await response.json();
        
        if (data.success) {
            setTokens(getTokens() + data.newUserTokens);
            showToast(`+${data.newUserTokens} —Ç–æ–∫–µ–Ω–æ–≤! –°–ø–∞—Å–∏–±–æ!`);
            input.value = '';
            return;
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        if (data.error === 'Already used referral') showToast('–í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –∫–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è');
        else if (data.error === 'Invalid referral code') showToast('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥');
        else if (data.error === 'Cannot refer yourself') showToast('–ù–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ–π –∫–æ–¥');
        else if (data.error === 'Already used') showToast('–í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥');
        else if (data.error === 'Code expired') showToast('–ö–æ–¥ –±–æ–ª—å—à–µ –Ω–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç');
        else showToast('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥');
        
    } catch (err) {
        showToast('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
        console.error('Apply code error:', err);
    }
}

// –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º
function shareRefCode() {
    const code = document.getElementById('myRefCode').value;
    if (!code) {
        showToast('–ö–æ–¥ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
        return;
    }
    
    const text = `–ü–æ–ø—Ä–æ–±—É–π SKLADITO ‚Äî –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É—á—ë—Ç–∞ –≤–µ—â–µ–π! üì¶\n\n–ò—Å–ø–æ–ª—å–∑—É–π –º–æ–π –∫–æ–¥ ${code} –∏ –ø–æ–ª—É—á–∏ –±–æ–Ω—É—Å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã!\n\nhttps://76330-blip.github.io/skladito/phone/`;
    
    if (navigator.share) {
        navigator.share({ text }).catch(() => {
            navigator.clipboard.writeText(text);
            showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!');
        });
    } else {
        navigator.clipboard.writeText(text);
        showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!');
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å toast-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
function showToast(message) {
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π toast –µ—Å–ª–∏ –µ—Å—Ç—å
    const oldToast = document.querySelector('.toast');
    if (oldToast) oldToast.remove();
    
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
function updateStatus(msg) {
    console.log(msg);
}

function init() {
    loadFromStorage();
    updateStorageIndicator();
    updateTokensDisplay();
    setupEventListeners();
    setupOnboarding();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
    if (!localStorage.getItem('skladito_onboarding_done')) {
        showOnboarding();
    } else {
        renderMain();
    }
}

// –û–ù–ë–û–†–î–ò–ù–ì
let currentSlide = 0;
const totalSlides = 4;

function showOnboarding() {
    document.getElementById('onboarding').classList.add('active');
    currentSlide = 0;
    updateOnboardingUI();
}

function setupOnboarding() {
    document.getElementById('onboardingBtn').addEventListener('click', nextSlide);
    document.getElementById('onboardingSkip').addEventListener('click', finishOnboarding);
    
    // –°–≤–∞–π–ø –ø–æ–¥–¥–µ—Ä–∂–∫–∞
    const slides = document.getElementById('onboardingSlides');
    let startX = 0;
    
    slides.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
    });
    
    slides.addEventListener('touchend', (e) => {
        const endX = e.changedTouches[0].clientX;
        const diff = startX - endX;
        
        if (Math.abs(diff) > 50) {
            if (diff > 0 && currentSlide < totalSlides - 1) {
                currentSlide++;
                updateOnboardingUI();
            } else if (diff < 0 && currentSlide > 0) {
                currentSlide--;
                updateOnboardingUI();
            }
        }
    });
}

function nextSlide() {
    if (currentSlide < totalSlides - 1) {
        currentSlide++;
        updateOnboardingUI();
    } else {
        finishOnboarding();
    }
}

function updateOnboardingUI() {
    // –°–∫—Ä–æ–ª–ª –∫ —Å–ª–∞–π–¥—É
    const slides = document.getElementById('onboardingSlides');
    slides.scrollTo({ left: currentSlide * window.innerWidth, behavior: 'smooth' });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫–∏
    document.querySelectorAll('.onboarding-dot').forEach((dot, i) => {
        dot.classList.toggle('active', i === currentSlide);
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
    const btn = document.getElementById('onboardingBtn');
    btn.textContent = currentSlide === totalSlides - 1 ? '–ù–∞—á–∞—Ç—å' : '–î–∞–ª–µ–µ';
}

function finishOnboarding() {
    localStorage.setItem('skladito_onboarding_done', 'true');
    document.getElementById('onboarding').classList.remove('active');
    renderMain();
}

// –ó–ê–ì–†–£–ó–ö–ê –ò–ó LOCALSTORAGE
function loadFromStorage() {
    try {
        state.containers = JSON.parse(localStorage.getItem('skladito_containers') || '[]');
        state.items = JSON.parse(localStorage.getItem('skladito_items') || '[]');
        state.categories = JSON.parse(localStorage.getItem('skladito_categories') || '[]');
        
        if (state.categories.length === 0) {
            state.categories = DEFAULT_CATEGORIES;
            saveToStorage();
        }
        
        updateStatus('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
        updateStatus('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
    }
}

// –°–û–•–†–ê–ù–ï–ù–ò–ï –í LOCALSTORAGE
function saveToStorage() {
    try {
        localStorage.setItem('skladito_containers', JSON.stringify(state.containers));
        localStorage.setItem('skladito_items', JSON.stringify(state.items));
        localStorage.setItem('skladito_categories', JSON.stringify(state.categories));
        localStorage.setItem('skladito_version', '2.0');
        updateStorageIndicator();
        updateStatus('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
        updateStatus('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        
        if (error.name === 'QuotaExceededError') {
            alert('–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–∞! –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ —Ñ–æ—Ç–æ.');
        }
    }
}

// –ò–ù–î–ò–ö–ê–¢–û–† –•–†–ê–ù–ò–õ–ò–©–ê
function updateStorageIndicator() {
    const usage = getStorageUsage();
    document.getElementById('burgerStorageUsed').textContent = usage.usedMB + ' –ú–ë';
    
    const fill = document.getElementById('burgerStorageFill');
    fill.style.width = usage.percent + '%';
    
    fill.className = 'storage-fill';
    if (usage.percent > 80) fill.classList.add('danger');
    else if (usage.percent > 60) fill.classList.add('warning');
    
    if (usage.percent > 80) {
        updateStatus('‚ö†Ô∏è –•—Ä–∞–Ω–∏–ª–∏—â–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –Ω–∞ ' + usage.percent + '%');
    }
}

function getStorageUsage() {
    let total = 0;
    for (let key in localStorage) {
        if (localStorage.hasOwnProperty(key) && key.startsWith('skladito_')) {
            total += localStorage[key].length + key.length;
        }
    }
    return {
        used: total,
        usedMB: (total / 1024 / 1024).toFixed(2),
        percent: Math.min(100, Math.round((total / (5 * 1024 * 1024)) * 100))
    };
}

// –ë–£–†–ì–ï–†-–ú–ï–ù–Æ
function openBurgerMenu() {
    document.getElementById('burgerMenu').classList.add('active');
    document.getElementById('burgerOverlay').classList.add('active');
    updateStorageIndicator();
    updateShoppingBadge();
}

function closeBurgerMenu() {
    document.getElementById('burgerMenu').classList.remove('active');
    document.getElementById('burgerOverlay').classList.remove('active');
}

// –°–ñ–ê–¢–ò–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô
async function compressImage(file, maxSizeKB = 500) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                const maxDimension = 1024;
                if (width > maxDimension || height > maxDimension) {
                    if (width > height) {
                        height = (height / width) * maxDimension;
                        width = maxDimension;
                    } else {
                        width = (width / height) * maxDimension;
                        height = maxDimension;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                let quality = 0.8;
                let result = canvas.toDataURL('image/jpeg', quality);
                
                while (result.length > maxSizeKB * 1024 && quality > 0.1) {
                    quality -= 0.1;
                    result = canvas.toDataURL('image/jpeg', quality);
                }
                
                resolve(result);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });
}

// –≠–ö–°–ü–û–†–¢ –î–ê–ù–ù–´–•
function exportData() {
    const data = {
        version: '2.8',
        branch: 'phone',
        exportDate: new Date().toISOString(),
        containers: state.containers,
        items: state.items,
        categories: state.categories,
        tokens: getTokens(),
        userId: getUserId()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], {
        type: 'application/json'
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `skladito-backup-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
}

// –ò–ú–ü–û–†–¢ –î–ê–ù–ù–´–•
function importData(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);
            
            // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–µ—Ä—Å–∏–π 2.0 –∏ 2.2
            if (!data.version || !data.version.startsWith('2.')) {
                alert('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è –≤–µ—Ä—Å–∏—è –¥–∞–Ω–Ω—ã—Ö');
                return;
            }
            
            if (!confirm('–ò–º–ø–æ—Ä—Ç –∑–∞–º–µ–Ω–∏—Ç –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                return;
            }
            
            const backup = {
                containers: state.containers,
                items: state.items,
                categories: state.categories,
                tokens: getTokens()
            };
            localStorage.setItem('skladito_backup', JSON.stringify(backup));
            
            state.containers = data.containers || [];
            state.items = data.items || [];
            state.categories = data.categories || DEFAULT_CATEGORIES;
            
            // –ò–º–ø–æ—Ä—Ç —Ç–æ–∫–µ–Ω–æ–≤ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (data.tokens !== undefined) {
                setTokens(data.tokens);
            }
            
            // –ò–º–ø–æ—Ä—Ç userId –µ—Å–ª–∏ –µ—Å—Ç—å (–¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏)
            if (data.userId) {
                localStorage.setItem('skladito_user_id', data.userId);
            }
            
            saveToStorage();
            renderMain();
            showToast('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + error.message);
        }
    };
    reader.readAsText(file);
    
    event.target.value = '';
}

function setupEventListeners() {
    document.getElementById('backBtn').addEventListener('click', handleBack);
    document.getElementById('burgerBtn').addEventListener('click', openBurgerMenu);
    document.getElementById('fabBtn').addEventListener('click', toggleFabMenu);
    document.getElementById('searchInput').addEventListener('input', handleSearch);
    document.getElementById('addContainerForm').addEventListener('submit', handleAddContainer);
    document.getElementById('addItemForm').addEventListener('submit', handleAddItem);
    document.getElementById('editForm').addEventListener('submit', handleEdit);
    document.getElementById('deleteBtn').addEventListener('click', handleDelete);
    document.getElementById('containerPhoto').addEventListener('change', (e) => previewPhoto(e, 'containerPhotoPreview'));
    document.getElementById('itemPhoto').addEventListener('change', (e) => previewPhoto(e, 'itemPhotoPreview'));
    
    document.addEventListener('click', (e) => {
        const fab = document.getElementById('fabBtn');
        const menu = document.getElementById('fabMenu');
        if (!fab.contains(e.target) && !menu.contains(e.target)) {
            menu.classList.remove('active');
        }
    });
}

function toggleFabMenu(e) {
    e.stopPropagation();
    document.getElementById('fabMenu').classList.toggle('active');
}

function openAddContainerModal() {
    document.getElementById('fabMenu').classList.remove('active');
    // –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω—è–µ–º –Ω–æ–º–µ—Ä
    const nextNum = getNextContainerNumber(state.currentContainer);
    document.getElementById('containerNumber').value = nextNum;
    openModal('addContainerModal');
}

function openAddItemModal() {
    document.getElementById('fabMenu').classList.remove('active');
    fillCategorySelect();
    openModal('addItemModal');
}

function openCategoriesModal() {
    renderCategoriesList();
    openModal('categoriesModal');
}

function renderMain() {
    state.viewMode = 'main';
    state.currentContainer = null;
    
    document.getElementById('breadcrumbsBar').style.display = 'none';
    document.getElementById('backBtn').style.display = 'none';
    document.getElementById('searchContainer').style.display = 'block';
    document.getElementById('fabBtn').style.display = 'block';
    
    const rootContainers = state.containers.filter(c => !c.parent);
    let html = '';
    
    if (rootContainers.length > 0) {
        html += '<h3 style="margin:20px 0 12px 0;">–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã</h3>';
        rootContainers.forEach(c => html += renderContainerCard(c));
    }
    
    if (rootContainers.length === 0 && state.items.length === 0) {
        html += `
            <div class="empty-state">
                <div class="empty-state-icon">üì¶</div>
                <div class="empty-state-text">–°–∫–ª–∞–¥ –ø—É—Å—Ç</div>
                <div>–ù–∞–∂–º–∏—Ç–µ + —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</div>
            </div>
        `;
    }
    
    document.getElementById('mainContent').innerHTML = html;
}

function renderCategoriesList() {
    let html = '';
    state.categories.forEach(cat => {
        const count = state.items.filter(i => i.category === cat.id).length;
        html += `
            <div style="display:flex;align-items:center;padding:12px 0;border-bottom:1px solid #eee;">
                <span style="font-size:28px;margin-right:12px;cursor:pointer;" onclick="changeCategoryIcon('${cat.id}')" title="–°–º–µ–Ω–∏—Ç—å –∏–∫–æ–Ω–∫—É">${cat.icon}</span>
                <div style="flex:1;cursor:pointer;" onclick="showCategoryFromList('${cat.id}')">
                    <div style="font-weight:600;">${cat.name}</div>
                    <div style="font-size:12px;color:#999;">–ü—Ä–µ–¥–º–µ—Ç–æ–≤: ${count}</div>
                </div>
                <button onclick="renameCategoryPrompt('${cat.id}')" style="background:none;border:none;font-size:18px;cursor:pointer;padding:5px;" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                <button onclick="deleteCategory('${cat.id}')" style="background:none;border:none;font-size:18px;cursor:pointer;padding:5px;" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
            </div>
        `;
    });
    if (state.categories.length === 0) {
        html = '<div style="text-align:center;color:#999;padding:20px;">–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π</div>';
    }
    document.getElementById('categoriesList').innerHTML = html;
}

function showCategoryFromList(categoryId) {
    closeModal('categoriesModal');
    showCategory(categoryId);
}

function renderContainerCard(container) {
    const children = state.containers.filter(c => c.parent === container.id).length;
    const items = state.items.filter(i => i.container === container.id).length;
    const total = children + items;
    const num = container.number || '?';
    
    const thumb = container.photo 
        ? `<img src="${container.photo}" class="card-thumb">` 
        : `<div class="card-icon">üì¶</div>`;
    
    let html = `
        <div class="card" onclick="openContainer('${container.id}')">
            <div class="card-header">
                ${thumb}
                <div class="card-title"><span style="color:#667eea;font-family:'Courier New',monospace;font-weight:700;">#${num}</span> ${container.name}</div>
                ${total > 0 ? `<div class="card-badge">${total}</div>` : ''}
            </div>
            <div class="card-info">
                ${children > 0 ? `–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤: ${children} ` : ''}
                ${items > 0 ? `–ü—Ä–µ–¥–º–µ—Ç–æ–≤: ${items}` : ''}
                ${total === 0 ? '–ü—É—Å—Ç–æ' : ''}
            </div>
        </div>
    `;
    
    return html;
}

function renderItemCard(item) {
    const category = state.categories.find(c => c.id === item.category);
    const belowMin = item.minQuantity > 0 && item.quantity < item.minQuantity;
    
    const thumb = item.photo 
        ? `<img src="${item.photo}" class="card-thumb">` 
        : `<div class="card-icon">${category ? category.icon : 'üìå'}</div>`;
    
    let html = `
        <div class="card" onclick="editItem('${item.id}')" ${belowMin ? 'style="border-left:4px solid #dc3545;"' : ''}>
            <div class="card-header">
                ${thumb}
                <div class="card-title">${item.name}</div>
                <div class="card-badge" ${belowMin ? 'style="background:#dc3545;"' : ''}>√ó${item.quantity}</div>
            </div>
    `;
    
    let info = [];
    if (category) info.push(`${category.icon} ${category.name}`);
    if (belowMin) info.push(`<span style="color:#dc3545;font-weight:600;">‚ö†Ô∏è –ù—É–∂–Ω–æ –∫—É–ø–∏—Ç—å (–º–∏–Ω: ${item.minQuantity})</span>`);
    if (info.length > 0) html += `<div class="card-info">${info.join(' ¬∑ ')}</div>`;
    
    html += '</div>';
    return html;
}

function openContainer(containerId) {
    state.viewMode = 'container';
    state.currentContainer = containerId;
    
    const container = state.containers.find(c => c.id === containerId);
    if (!container) return;
    
    document.getElementById('breadcrumbs').textContent = getContainerPath(containerId);
    document.getElementById('breadcrumbsBar').style.display = 'block';
    document.getElementById('backBtn').style.display = 'block';
    document.getElementById('searchContainer').style.display = 'none';
    document.getElementById('fabBtn').style.display = 'block';
    
    const childContainers = state.containers.filter(c => c.parent === containerId);
    const items = state.items.filter(i => i.container === containerId);
    
    let html = `
        <div class="card" style="padding:12px;">
            <div class="card-header" style="margin-bottom:0;">
                ${container.photo ? `<img src="${container.photo}" class="card-thumb">` : `<div class="card-icon">üì¶</div>`}
                <div class="card-title"><span style="color:#667eea;font-family:'Courier New',monospace;font-weight:700;">#${container.number || '?'}</span> ${container.name}</div>
            </div>
            <div style="display:flex;gap:8px;margin-top:10px;">
                <button onclick="editContainer('${containerId}')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#667eea;color:white;font-size:18px;cursor:pointer;">‚úèÔ∏è</button>
                <button onclick="showQRCode('${containerId}')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#28a745;color:white;font-size:18px;cursor:pointer;">QR</button>
                <button onclick="openScannerModal()" style="flex:1;padding:10px;border:none;border-radius:10px;background:#fd7e14;color:white;font-size:18px;cursor:pointer;">üì∑</button>
            </div>
        </div>
    `;
    
    if (childContainers.length > 0) {
        html += '<h3 style="margin:20px 0 12px 0;">–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã</h3>';
        childContainers.forEach(c => html += renderContainerCard(c));
    }
    
    if (items.length > 0) {
        html += '<h3 style="margin:20px 0 12px 0;">–ü—Ä–µ–¥–º–µ—Ç—ã</h3>';
        items.forEach(item => html += renderItemCard(item));
    }
    
    if (childContainers.length === 0 && items.length === 0) {
        html += `
            <div class="empty-state">
                <div class="empty-state-icon">üì≠</div>
                <div class="empty-state-text">–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—É—Å—Ç</div>
            </div>
        `;
    }
    
    document.getElementById('mainContent').innerHTML = html;
}

function showCategory(categoryId) {
    state.viewMode = 'category';
    const category = state.categories.find(c => c.id === categoryId);
    if (!category) return;
    
    document.getElementById('breadcrumbs').textContent = `–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${category.name}`;
    document.getElementById('breadcrumbsBar').style.display = 'block';
    document.getElementById('backBtn').style.display = 'block';
    document.getElementById('searchContainer').style.display = 'none';
    document.getElementById('fabBtn').style.display = 'none';
    
    const items = state.items.filter(i => i.category === categoryId);
    
    let html = `<h2 style="margin-bottom:20px;">${category.icon} ${category.name}</h2>`;
    
    if (items.length > 0) {
        items.forEach(item => {
            const container = state.containers.find(c => c.id === item.container);
            let itemHtml = renderItemCard(item);
            if (container) {
                const path = getContainerPath(container.id);
                itemHtml = itemHtml.replace('</div>', `<div class="card-info">üìç ${path}</div></div>`);
            }
            html += itemHtml;
        });
    } else {
        html += `
            <div class="empty-state">
                <div class="empty-state-icon">üîç</div>
                <div class="empty-state-text">–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>
            </div>
        `;
    }
    
    document.getElementById('mainContent').innerHTML = html;
}

function handleSearch(e) {
    const query = e.target.value.toLowerCase().trim();
    
    if (!query) {
        renderMain();
        return;
    }
    
    state.viewMode = 'search';
    document.getElementById('backBtn').style.display = 'none';
    document.getElementById('fabBtn').style.display = 'none';
    
    const foundContainers = state.containers.filter(c => c.name.toLowerCase().includes(query));
    const foundItems = state.items.filter(i => i.name.toLowerCase().includes(query));
    
    let html = `<h3 style="margin-bottom:12px;">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã: "${query}"</h3>`;
    
    if (foundContainers.length > 0) {
        html += '<h4 style="margin:20px 0 12px 0;">–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã</h4>';
        foundContainers.forEach(c => html += renderContainerCard(c));
    }
    
    if (foundItems.length > 0) {
        html += '<h4 style="margin:20px 0 12px 0;">–ü—Ä–µ–¥–º–µ—Ç—ã</h4>';
        foundItems.forEach(item => html += renderItemCard(item));
    }
    
    if (foundContainers.length === 0 && foundItems.length === 0) {
        html += `
            <div class="empty-state">
                <div class="empty-state-icon">üîç</div>
                <div class="empty-state-text">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
            </div>
        `;
    }
    
    document.getElementById('mainContent').innerHTML = html;
}

function handleBack() {
    if (state.viewMode === 'container' && state.currentContainer) {
        const container = state.containers.find(c => c.id === state.currentContainer);
        if (container && container.parent) {
            openContainer(container.parent);
        } else {
            renderMain();
        }
    } else {
        renderMain();
    }
}

function openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
    
    if (modalId === 'addContainerModal') {
        document.getElementById('addContainerForm').reset();
        document.getElementById('containerPhotoPreview').style.display = 'none';
    }
    if (modalId === 'addItemModal') {
        document.getElementById('addItemForm').reset();
        document.getElementById('itemPhotoPreview').style.display = 'none';
    }
}

function fillCategorySelect(selectId) {
    selectId = selectId || 'itemCategory';
    const select = document.getElementById(selectId);
    const currentVal = select.value;
    select.innerHTML = '<option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>';
    state.categories.forEach(cat => {
        select.innerHTML += `<option value="${cat.id}" ${cat.id === currentVal ? 'selected' : ''}>${cat.icon} ${cat.name}</option>`;
    });
}

// –ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è –∏–∑ —Ñ–æ—Ä–º—ã –ø—Ä–µ–¥–º–µ—Ç–∞
function showNewCategoryInput(context) {
    document.getElementById('newCategory' + (context === 'item' ? 'Item' : 'Edit')).style.display = 'block';
    document.getElementById('newCategoryName' + (context === 'item' ? 'Item' : 'Edit')).focus();
}

function hideNewCategoryInput(context) {
    document.getElementById('newCategory' + (context === 'item' ? 'Item' : 'Edit')).style.display = 'none';
    document.getElementById('newCategoryName' + (context === 'item' ? 'Item' : 'Edit')).value = '';
}

function addNewCategory(context) {
    const inputId = 'newCategoryName' + (context === 'item' ? 'Item' : 'Edit');
    const selectId = context === 'item' ? 'itemCategory' : 'editCategory';
    const name = document.getElementById(inputId).value.trim();
    
    if (!name) {
        showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
        return;
    }
    
    const newCat = {
        id: 'cat' + Date.now(),
        name: name,
        icon: 'üìÇ',
        order: state.categories.length
    };
    
    state.categories.push(newCat);
    saveToStorage();
    
    fillCategorySelect(selectId);
    document.getElementById(selectId).value = newCat.id;
    
    hideNewCategoryInput(context);
    showToast(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è "${name}" –¥–æ–±–∞–≤–ª–µ–Ω–∞!`);
}

// –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ –º–æ–¥–∞–ª–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
function addCategoryFromModal() {
    const name = document.getElementById('newCategoryNameModal').value.trim();
    if (!name) {
        showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
        return;
    }
    
    const newCat = {
        id: 'cat' + Date.now(),
        name: name,
        icon: 'üìÇ',
        order: state.categories.length
    };
    
    state.categories.push(newCat);
    saveToStorage();
    document.getElementById('newCategoryNameModal').value = '';
    renderCategoriesList();
    showToast(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è "${name}" –¥–æ–±–∞–≤–ª–µ–Ω–∞!`);
}

function deleteCategory(catId) {
    const cat = state.categories.find(c => c.id === catId);
    if (!cat) return;
    
    const itemCount = state.items.filter(i => i.category === catId).length;
    const msg = itemCount > 0 
        ? `–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é "${cat.name}"? –£ ${itemCount} –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –±—É–¥–µ—Ç —Å–Ω—è—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è.` 
        : `–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é "${cat.name}"?`;
    
    if (!confirm(msg)) return;
    
    // –°–Ω–∏–º–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å –ø—Ä–µ–¥–º–µ—Ç–æ–≤
    state.items.forEach(item => {
        if (item.category === catId) item.category = null;
    });
    
    state.categories = state.categories.filter(c => c.id !== catId);
    saveToStorage();
    renderCategoriesList();
    showToast('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞');
}

function renameCategoryPrompt(catId) {
    const cat = state.categories.find(c => c.id === catId);
    if (!cat) return;
    
    const newName = prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:', cat.name);
    if (!newName || !newName.trim()) return;
    
    cat.name = newName.trim();
    saveToStorage();
    renderCategoriesList();
    showToast('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞');
}

function changeCategoryIcon(catId) {
    const cat = state.categories.find(c => c.id === catId);
    if (!cat) return;
    
    const icons = ['üìÇ','üîß','üìù','üè†','‚ö°','üëï','üéÆ','üç≥','üíä','üß¥','üßπ','üìö','üé®','üèãÔ∏è','üîë','ü™¥','üß∏','üéÅ','üõ†Ô∏è','üß≤','üì¶','ü•´','üßª','üí°','üîå','üß§','üëü','üéí','üß≥','üì∑'];
    
    let html = '<div style="display:flex;flex-wrap:wrap;gap:8px;padding:10px;">';
    icons.forEach(icon => {
        html += `<span style="font-size:28px;cursor:pointer;padding:6px;border-radius:8px;${icon === cat.icon ? 'background:#667eea33;' : ''}" onclick="setCategoryIcon('${catId}','${icon}')">${icon}</span>`;
    });
    html += '</div><div style="margin-top:10px;"><input type="text" class="form-input" id="customIconInput" placeholder="–ò–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ–π —ç–º–æ–¥–∑–∏" maxlength="2" style="text-align:center;font-size:24px;width:80px;display:inline-block;"><button class="btn btn-small" onclick="setCategoryIcon(\'${catId}\', document.getElementById(\'customIconInput\').value)" style="width:auto;padding:8px 14px;margin:0 0 0 8px;">OK</button></div>';
    
    document.getElementById('categoriesList').innerHTML = html;
}

function setCategoryIcon(catId, icon) {
    if (!icon) return;
    const cat = state.categories.find(c => c.id === catId);
    if (!cat) return;
    
    cat.icon = icon;
    saveToStorage();
    renderCategoriesList();
    showToast('–ò–∫–æ–Ω–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∞');
}

function changeCategoryIcon(catId) {
    const cat = state.categories.find(c => c.id === catId);
    if (!cat) return;
    
    const icons = ['üìÇ','üîß','üìù','üè†','‚ö°','üëï','üçΩÔ∏è','üíä','üßπ','üéÆ','üìö','üîë','üß∞','üéí','üß∏','ü™¥','üèãÔ∏è','üé®','üß™','üì¶','üõ†Ô∏è','üí°','üîå','üß≤','ü™ú'];
    
    let html = '<div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;padding:10px;">';
    icons.forEach(icon => {
        html += `<span style="font-size:32px;cursor:pointer;padding:8px;border-radius:8px;${icon === cat.icon ? 'background:#667eea22;' : ''}" onclick="setCategoryIcon('${catId}','${icon}')">${icon}</span>`;
    });
    html += '</div><div style="text-align:center;margin-top:10px;"><button class="btn btn-secondary btn-small" onclick="customCategoryIcon(\''+catId+'\')">–í–≤–µ—Å—Ç–∏ —Å–≤–æ–π —ç–º–æ–¥–∑–∏</button></div>';
    
    document.getElementById('categoriesList').innerHTML = html;
}

function setCategoryIcon(catId, icon) {
    const cat = state.categories.find(c => c.id === catId);
    if (!cat) return;
    
    cat.icon = icon;
    saveToStorage();
    renderCategoriesList();
    showToast('–ò–∫–æ–Ω–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
}

function customCategoryIcon(catId) {
    const cat = state.categories.find(c => c.id === catId);
    if (!cat) return;
    
    const icon = prompt('–í–≤–µ–¥–∏—Ç–µ —ç–º–æ–¥–∑–∏:', cat.icon);
    if (!icon) return;
    
    cat.icon = icon.trim().slice(0, 2);
    saveToStorage();
    renderCategoriesList();
    showToast('–ò–∫–æ–Ω–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
}

async function previewPhoto(e, previewId) {
    const file = e.target.files[0];
    if (!file) return;
    
    const compressed = await compressImage(file);
    const img = document.getElementById(previewId);
    img.src = compressed;
    img.style.display = 'block';
}

async function handleAddContainer(e) {
    e.preventDefault();
    
    const name = document.getElementById('containerName').value;
    const numberInput = document.getElementById('containerNumber').value;
    const number = numberInput ? String(parseInt(numberInput)).padStart(4, '0') : getNextContainerNumber(state.currentContainer);
    const photoFile = document.getElementById('containerPhoto').files[0];
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–æ–º–µ—Ä–∞
    if (!isNumberUnique(number, state.currentContainer, null)) {
        showToast('–ù–æ–º–µ—Ä ' + number + ' —É–∂–µ –∑–∞–Ω—è—Ç!');
        return;
    }
    
    let photo = null;
    if (photoFile) {
        photo = await compressImage(photoFile);
    }
    
    const container = {
        id: 'c' + Date.now(),
        name: name,
        number: number,
        photo: photo,
        parent: state.currentContainer,
        created: new Date().toISOString()
    };
    
    state.containers.push(container);
    saveToStorage();
    closeModal('addContainerModal');
    
    // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
    document.getElementById('containerNumber').value = '';
    document.getElementById('containerName').value = '';
    document.getElementById('containerPhoto').value = '';
    document.getElementById('containerPhotoPreview').style.display = 'none';
    
    if (state.currentContainer) {
        openContainer(state.currentContainer);
    } else {
        renderMain();
    }
}

async function handleAddItem(e) {
    e.preventDefault();
    
    const name = document.getElementById('itemName').value;
    const quantity = parseInt(document.getElementById('itemQuantity').value);
    const minQuantity = parseInt(document.getElementById('itemMinQuantity').value) || 0;
    const category = document.getElementById('itemCategory').value || null;
    const photoFile = document.getElementById('itemPhoto').files[0];
    
    let photo = null;
    if (photoFile) {
        photo = await compressImage(photoFile);
    }
    
    const item = {
        id: 'i' + Date.now(),
        name: name,
        quantity: quantity,
        minQuantity: minQuantity,
        category: category,
        photo: photo,
        container: state.currentContainer,
        created: new Date().toISOString()
    };
    
    state.items.push(item);
    saveToStorage();
    closeModal('addItemModal');
    openContainer(state.currentContainer);
}

function editContainer(containerId) {
    const container = state.containers.find(c => c.id === containerId);
    if (!container) return;
    
    state.editingObject = { type: 'container', data: container };
    
    document.getElementById('editModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä';
    
    // –°–æ–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ä–æ–¥–∏—Ç–µ–ª–µ–π (–∏—Å–∫–ª—é—á–∞–µ–º —Å–∞–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –µ–≥–æ –ø–æ—Ç–æ–º–∫–æ–≤)
    const descendants = getDescendantIds(containerId);
    const possibleParents = state.containers.filter(c => c.id !== containerId && !descendants.includes(c.id));
    
    const currentParentName = container.parent 
        ? (state.containers.find(c => c.id === container.parent)?.name || '?') 
        : '–ì–ª–∞–≤–Ω–∞—è (–∫–æ—Ä–µ–Ω—å)';
    
    let html = `
        <input type="hidden" id="editType" value="container">
        <input type="hidden" id="editId" value="${container.id}">
        <div class="form-group">
            <label class="form-label">–ù–æ–º–µ—Ä</label>
            <input type="text" class="form-input" id="editNumber" value="${container.number || ''}" maxlength="4" pattern="[0-9]{1,4}" style="font-size:24px;text-align:center;font-weight:700;letter-spacing:4px;font-family:'Courier New',monospace;">
        </div>
        <div class="form-group">
            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input type="text" class="form-input" id="editName" value="${container.name}" required>
        </div>
        <div class="form-group">
            <label class="form-label">üìç –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ: <strong>${currentParentName}</strong></label>
            <select class="form-select" id="editParent">
                <option value="" ${!container.parent ? 'selected' : ''}>üè† –ì–ª–∞–≤–Ω–∞—è (–∫–æ—Ä–µ–Ω—å)</option>
                ${possibleParents.map(c => 
                    `<option value="${c.id}" ${c.id === container.parent ? 'selected' : ''}>${c.number ? '#' + c.number + ' ' : ''}${c.name} (${getContainerPath(c.id)})</option>`
                ).join('')}
            </select>
        </div>
    `;
    
    if (container.photo) {
        html += `
            <div class="form-group">
                <label class="form-label">–§–æ—Ç–æ</label>
                <img src="${container.photo}" class="photo-preview" id="editPhotoPreview">
                <div class="photo-actions">
                    <button type="button" class="btn-small" onclick="document.getElementById('editPhotoInput').click()">–ó–∞–º–µ–Ω–∏—Ç—å</button>
                    <button type="button" class="btn-small btn-danger" onclick="deletePhoto()">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </div>
        `;
    } else {
        html += `
            <div class="form-group">
                <label class="form-label">–§–æ—Ç–æ</label>
                <div class="photo-upload-btn" onclick="document.getElementById('editPhotoInput').click()">
                    üì∑ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
                </div>
                <img id="editPhotoPreview" class="photo-preview" style="display:none;">
            </div>
        `;
    }
    
    html += '<input type="file" class="photo-upload" id="editPhotoInput" accept="image/*">';
    
    document.getElementById('editFormContent').innerHTML = html;
    document.getElementById('editPhotoInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
            const compressed = await compressImage(file);
            const img = document.getElementById('editPhotoPreview');
            img.src = compressed;
            img.style.display = 'block';
        }
    });
    openModal('editModal');
}

function editItem(itemId) {
    const item = state.items.find(i => i.id === itemId);
    if (!item) return;
    
    state.editingObject = { type: 'item', data: item };
    
    document.getElementById('editModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç';
    
    let html = `
        <input type="hidden" id="editType" value="item">
        <input type="hidden" id="editId" value="${item.id}">
        <div class="form-group">
            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input type="text" class="form-input" id="editName" value="${item.name}" required>
        </div>
        <div class="form-group">
            <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
            <input type="number" class="form-input" id="editQuantity" value="${item.quantity}" min="0" required>
        </div>
        <div class="form-group">
            <label class="form-label">–ú–∏–Ω. –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ <span style="color:#999;font-weight:400;">(–¥–ª—è —Å–ø–∏—Å–∫–∞ –ø–æ–∫—É–ø–æ–∫)</span></label>
            <input type="number" class="form-input" id="editMinQuantity" value="${item.minQuantity || 0}" min="0">
        </div>
        <div class="form-group">
            <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            <div style="display:flex;gap:8px;">
                <select class="form-select" id="editCategory" style="flex:1;">
                    <option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                    ${state.categories.map(cat => 
                        `<option value="${cat.id}" ${cat.id === item.category ? 'selected' : ''}>${cat.icon} ${cat.name}</option>`
                    ).join('')}
                </select>
                <button type="button" class="btn btn-small" onclick="showNewCategoryInput('edit')" style="width:auto;padding:10px 14px;margin:0;white-space:nowrap;">+ –ù–æ–≤–∞—è</button>
            </div>
            <div id="newCategoryEdit" style="display:none;margin-top:8px;">
                <div style="display:flex;gap:8px;">
                    <input type="text" class="form-input" id="newCategoryNameEdit" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" style="flex:1;">
                    <button type="button" class="btn btn-small" onclick="addNewCategory('edit')" style="width:auto;padding:10px 14px;margin:0;">‚úì</button>
                    <button type="button" class="btn btn-small btn-secondary" onclick="hideNewCategoryInput('edit')" style="width:auto;padding:10px 14px;margin:0;">‚úï</button>
                </div>
            </div>
        </div>
    `;
    
    if (item.photo) {
        html += `
            <div class="form-group">
                <label class="form-label">–§–æ—Ç–æ</label>
                <img src="${item.photo}" class="photo-preview" id="editPhotoPreview">
                <div class="photo-actions">
                    <button type="button" class="btn-small" onclick="document.getElementById('editPhotoInput').click()">–ó–∞–º–µ–Ω–∏—Ç—å</button>
                    <button type="button" class="btn-small btn-danger" onclick="deletePhoto()">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </div>
        `;
    } else {
        html += `
            <div class="form-group">
                <label class="form-label">–§–æ—Ç–æ</label>
                <div class="photo-upload-btn" onclick="document.getElementById('editPhotoInput').click()">
                    üì∑ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
                </div>
                <img id="editPhotoPreview" class="photo-preview" style="display:none;">
            </div>
        `;
    }
    
    html += '<input type="file" class="photo-upload" id="editPhotoInput" accept="image/*">';
    
    document.getElementById('editFormContent').innerHTML = html;
    document.getElementById('editPhotoInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
            const compressed = await compressImage(file);
            const img = document.getElementById('editPhotoPreview');
            img.src = compressed;
            img.style.display = 'block';
        }
    });
    openModal('editModal');
}

function deletePhoto() {
    const preview = document.getElementById('editPhotoPreview');
    preview.style.display = 'none';
    preview.src = '';
    state.editingObject.data.photo = null;
}

async function handleEdit(e) {
    e.preventDefault();
    
    const type = document.getElementById('editType').value;
    const id = document.getElementById('editId').value;
    const name = document.getElementById('editName').value;
    
    const photoInput = document.getElementById('editPhotoInput');
    let newPhoto = null;
    if (photoInput.files[0]) {
        newPhoto = await compressImage(photoInput.files[0]);
    }
    
    if (type === 'container') {
        const container = state.containers.find(c => c.id === id);
        container.name = name;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–º–µ—Ä –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª–µ
        const numberInput = document.getElementById('editNumber');
        if (numberInput) {
            const newNumber = numberInput.value ? String(parseInt(numberInput.value)).padStart(4, '0') : container.number;
            if (newNumber !== container.number && !isNumberUnique(newNumber, container.parent, container.id)) {
                showToast('–ù–æ–º–µ—Ä ' + newNumber + ' —É–∂–µ –∑–∞–Ω—è—Ç!');
                return;
            }
            container.number = newNumber;
        }
        
        // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        const parentSelect = document.getElementById('editParent');
        if (parentSelect) {
            const newParent = parentSelect.value || null;
            if (newParent !== container.parent) {
                container.parent = newParent;
                showToast('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–º–µ—â—ë–Ω!');
            }
        }
        
        if (newPhoto) container.photo = newPhoto;
        if (state.editingObject.data.photo === null) container.photo = null;
    } else {
        const item = state.items.find(i => i.id === id);
        item.name = name;
        item.quantity = parseInt(document.getElementById('editQuantity').value);
        item.minQuantity = parseInt(document.getElementById('editMinQuantity').value) || 0;
        item.category = document.getElementById('editCategory').value || null;
        if (newPhoto) item.photo = newPhoto;
        if (state.editingObject.data.photo === null) item.photo = null;
    }
    
    saveToStorage();
    closeModal('editModal');
    
    if (state.viewMode === 'container') {
        openContainer(state.currentContainer);
    } else {
        renderMain();
    }
}

function handleDelete() {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
    
    const type = document.getElementById('editType').value;
    const id = document.getElementById('editId').value;
    
    if (type === 'container') {
        const childCount = state.containers.filter(c => c.parent === id).length;
        const itemCount = state.items.filter(i => i.container === id).length;
        
        if (childCount > 0 || itemCount > 0) {
            alert(`–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –ø—É—Å—Ç–æ–π! –í–Ω—É—Ç—Ä–∏ ${childCount + itemCount} –æ–±—ä–µ–∫—Ç–æ–≤.`);
            return;
        }
        
        state.containers = state.containers.filter(c => c.id !== id);
    } else {
        state.items = state.items.filter(i => i.id !== id);
    }
    
    saveToStorage();
    closeModal('editModal');
    
    if (state.viewMode === 'container') {
        openContainer(state.currentContainer);
    } else {
        renderMain();
    }
}

function getDescendantIds(containerId) {
    let ids = [];
    const children = state.containers.filter(c => c.parent === containerId);
    children.forEach(child => {
        ids.push(child.id);
        ids = ids.concat(getDescendantIds(child.id));
    });
    return ids;
}

function getContainerPath(containerId) {
    const container = state.containers.find(c => c.id === containerId);
    if (!container) return '';
    
    let path = container.name;
    let current = container;
    
    while (current.parent) {
        const parent = state.containers.find(c => c.id === current.parent);
        if (!parent) break;
        path = parent.name + ' > ' + path;
        current = parent;
    }
    
    return '–ì–ª–∞–≤–Ω–∞—è > ' + path;
}

// ==================== –ù–û–ú–ï–†–ê –ö–û–ù–¢–ï–ô–ù–ï–†–û–í ====================

function getNextContainerNumber(parentId) {
    const siblings = state.containers.filter(c => c.parent === parentId);
    const usedNumbers = siblings.map(c => parseInt(c.number) || 0).filter(n => n > 0);
    
    for (let i = 1; i <= 9999; i++) {
        if (!usedNumbers.includes(i)) {
            return String(i).padStart(4, '0');
        }
    }
    return '0001';
}

function isNumberUnique(number, parentId, excludeId) {
    const num = parseInt(number);
    const siblings = state.containers.filter(c => c.parent === parentId && c.id !== excludeId);
    return !siblings.some(c => parseInt(c.number) === num);
}

// ==================== QR-–ö–û–î ====================

let qrCodeInstance = null;

function showQRCode(containerId) {
    const container = state.containers.find(c => c.id === containerId);
    if (!container) return;
    
    const number = container.number || '----';
    document.getElementById('qrNumber').textContent = number;
    document.getElementById('qrName').textContent = container.name;
    
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π QR
    const qrContainer = document.getElementById('qrCodeContainer');
    qrContainer.innerHTML = '';
    
    // QR —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ ID –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    new QRCode(qrContainer, {
        text: container.id,
        width: 200,
        height: 200,
        colorDark: '#000000',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.M
    });
    
    openModal('qrModal');
}

function printQR() {
    window.print();
}

function closeQrModal() {
    closeModal('qrModal');
}

// ==================== –°–ö–ê–ù–ï–† ====================

let html5QrScanner = null;
let scanMode = 'what';  // 'what' –∏–ª–∏ 'find'
let scanTarget = null;   // ID –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞

function openScannerModal() {
    document.getElementById('fabMenu').classList.remove('active');
    document.getElementById('scanResult').innerHTML = '';
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º select –¥–ª—è —Ä–µ–∂–∏–º–∞ "–Ω–∞–π—Ç–∏"
    const select = document.getElementById('scanTargetSelect');
    select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>';
    state.containers.forEach(c => {
        const num = c.number || '?';
        select.innerHTML += `<option value="${c.id}">#${num} ${c.name}</option>`;
    });
    
    setScanMode('what');
    openModal('scannerModal');
    startScanner();
}

function closeScannerModal() {
    stopScanner();
    closeModal('scannerModal');
}

function setScanMode(mode) {
    scanMode = mode;
    document.getElementById('scanModeWhat').classList.toggle('active', mode === 'what');
    document.getElementById('scanModeFind').classList.toggle('active', mode === 'find');
    document.getElementById('scanFindTarget').style.display = mode === 'find' ? 'block' : 'none';
    document.getElementById('scanResult').innerHTML = '';
    scanTarget = null;
}

function updateScanTarget() {
    scanTarget = document.getElementById('scanTargetSelect').value;
    document.getElementById('scanResult').innerHTML = '';
}

function startScanner() {
    try {
        html5QrScanner = new Html5Qrcode('scannerView');
        html5QrScanner.start(
            { facingMode: 'environment' },
            { fps: 10, qrbox: { width: 250, height: 250 } },
            onScanSuccess,
            () => {} // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –∫–∞–¥—Ä–æ–≤
        ).catch(err => {
            document.getElementById('scanResult').innerHTML = 
                '<div style="color:#dc3545;padding:12px;">‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.</div>';
        });
    } catch (err) {
        document.getElementById('scanResult').innerHTML = 
            '<div style="color:#dc3545;padding:12px;">‚ùå –°–∫–∞–Ω–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div>';
    }
}

function stopScanner() {
    if (html5QrScanner) {
        html5QrScanner.stop().catch(() => {});
        html5QrScanner = null;
    }
}

function onScanSuccess(decodedText) {
    // –ò—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ ID –∏–∑ QR-–∫–æ–¥–∞
    const container = state.containers.find(c => c.id === decodedText);
    if (!container) {
        document.getElementById('scanResult').innerHTML = 
            '<div style="color:#dc3545;padding:12px;">‚ùì QR-–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ</div>';
        return;
    }
    
    if (scanMode === 'what') {
        showScanResultWhat(container);
    } else {
        showScanResultFind(container);
    }
}

function showScanResultWhat(container) {
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä –ø–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞
    stopScanner();
    
    const childContainers = state.containers.filter(c => c.parent === container.id);
    const items = state.items.filter(i => i.container === container.id);
    const num = container.number || '?';
    
    let html = `
        <div class="scanner-found">
            <div class="found-icon">üì¶</div>
            <div class="found-text">#${num} ${container.name}</div>
        </div>
        <div class="scan-result-list" id="scanResultList">
    `;
    
    if (childContainers.length > 0) {
        html += '<h4 style="margin:12px 0 8px 0;">üì¶ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:</h4>';
        childContainers.forEach(c => {
            const cNum = c.number || '?';
            const cCount = state.containers.filter(x => x.parent === c.id).length + state.items.filter(x => x.container === c.id).length;
            html += `<div class="card" style="margin-bottom:8px;cursor:default;">
                <div class="card-header">
                    <div class="card-icon">üì¶</div>
                    <div class="card-title">#${cNum} ${c.name}</div>
                    ${cCount > 0 ? `<div class="card-badge">${cCount}</div>` : ''}
                </div>
            </div>`;
        });
    }
    
    if (items.length > 0) {
        html += '<h4 style="margin:12px 0 8px 0;">üìå –ü—Ä–µ–¥–º–µ—Ç—ã:</h4>';
        items.forEach(i => {
            const cat = state.categories.find(c => c.id === i.category);
            html += `<div class="card" style="margin-bottom:8px;cursor:default;">
                <div class="card-header">
                    <div class="card-icon">${cat ? cat.icon : 'üìå'}</div>
                    <div class="card-title">${i.name}</div>
                    <div class="card-badge">√ó${i.quantity}</div>
                </div>
            </div>`;
        });
    }
    
    if (childContainers.length === 0 && items.length === 0) {
        html += '<div style="text-align:center;padding:20px;color:#999;">–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—É—Å—Ç</div>';
    }
    
    html += '</div>';
    
    // –ö–Ω–æ–ø–∫–∞ "–ü–æ–∫–∞–∑–∞—Ç—å –í–°–ï –ø—Ä–µ–¥–º–µ—Ç—ã"
    if (childContainers.length > 0) {
        html += `<button class="all-items-toggle" onclick="showAllItemsInContainer('${container.id}')">üìã –ü–æ–∫–∞–∑–∞—Ç—å –í–°–ï –ø—Ä–µ–¥–º–µ—Ç—ã (–≤–∫–ª—é—á–∞—è –≤–ª–æ–∂–µ–Ω–Ω—ã–µ)</button>`;
    }
    
    // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
    html += `<button class="btn" style="margin-top:12px;" onclick="closeScannerModal(); openContainer('${container.id}');">üìÇ –û—Ç–∫—Ä—ã—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä</button>`;
    html += `<button class="btn btn-secondary" style="margin-top:8px;" onclick="restartScanner()">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –µ—â—ë</button>`;
    
    document.getElementById('scanResult').innerHTML = html;
}

function showAllItemsInContainer(containerId) {
    const allItems = getAllItemsRecursive(containerId);
    
    let html = `<h4 style="margin:12px 0 8px 0;">üìã –í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã (${allItems.length}):</h4>`;
    
    if (allItems.length === 0) {
        html += '<div style="text-align:center;padding:20px;color:#999;">–ü—Ä–µ–¥–º–µ—Ç–æ–≤ –Ω–µ—Ç</div>';
    } else {
        allItems.forEach(({ item, path }) => {
            const cat = state.categories.find(c => c.id === item.category);
            html += `<div class="card" style="margin-bottom:8px;cursor:default;">
                <div class="card-header">
                    <div class="card-icon">${cat ? cat.icon : 'üìå'}</div>
                    <div class="card-title">${item.name}</div>
                    <div class="card-badge">√ó${item.quantity}</div>
                </div>
                <div class="card-info" style="font-size:12px;color:#888;">üìç ${path}</div>
            </div>`;
        });
    }
    
    document.getElementById('scanResultList').innerHTML = html;
}

function getAllItemsRecursive(containerId) {
    let result = [];
    const container = state.containers.find(c => c.id === containerId);
    const containerName = container ? container.name : '';
    
    // –ü—Ä–µ–¥–º–µ—Ç—ã –≤ —ç—Ç–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
    const items = state.items.filter(i => i.container === containerId);
    items.forEach(item => {
        result.push({ item, path: containerName });
    });
    
    // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –ø–æ –≤–ª–æ–∂–µ–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º
    const children = state.containers.filter(c => c.parent === containerId);
    children.forEach(child => {
        const childItems = getAllItemsRecursive(child.id);
        childItems.forEach(ci => {
            ci.path = containerName + ' > ' + ci.path;
            result.push(ci);
        });
    });
    
    return result;
}

function showScanResultFind(container) {
    if (!scanTarget) {
        document.getElementById('scanResult').innerHTML = 
            '<div style="color:#856404;padding:12px;">‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–æ–∏—Å–∫–∞</div>';
        return;
    }
    
    if (container.id === scanTarget) {
        // –ù–ê–®–õ–ò!
        stopScanner();
        const num = container.number || '?';
        
        // –í–∏–±—Ä–∞—Ü–∏—è –µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        
        document.getElementById('scanResult').innerHTML = `
            <div class="scanner-found" style="background:#d4edda;border:3px solid #28a745;">
                <div class="found-icon">üéØ</div>
                <div class="found-text" style="color:#28a745;">–ù–∞–π–¥–µ–Ω!</div>
                <div style="font-size:32px;font-weight:800;margin-top:8px;">#${num}</div>
                <div style="font-size:16px;margin-top:4px;">${container.name}</div>
            </div>
            <button class="btn" style="margin-top:12px;" onclick="closeScannerModal(); openContainer('${container.id}');">üìÇ –û—Ç–∫—Ä—ã—Ç—å</button>
            <button class="btn btn-secondary" style="margin-top:8px;" onclick="restartScanner()">üì∑ –ò—Å–∫–∞—Ç—å –¥—Ä—É–≥–æ–π</button>
        `;
    } else {
        // –ù–µ —Ç–æ—Ç
        const num = container.number || '?';
        document.getElementById('scanResult').innerHTML = `
            <div style="background:#fff3cd;padding:12px;border-radius:10px;text-align:center;">
                <div>–≠—Ç–æ #${num} ${container.name}</div>
                <div style="color:#856404;margin-top:4px;">–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...</div>
            </div>
        `;
    }
}

function restartScanner() {
    document.getElementById('scanResult').innerHTML = '';
    startScanner();
}

// ==================== –û–ë–ù–û–í–õ–Å–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================

// ==================== –°–ü–ò–°–û–ö –ü–û–ö–£–ü–û–ö ====================

function getShoppingItems() {
    return state.items.filter(item => item.minQuantity > 0 && item.quantity < item.minQuantity);
}

function openShoppingList() {
    const items = getShoppingItems();
    let html = '';
    
    if (items.length === 0) {
        html = '<div style="text-align:center;padding:30px;color:#999;"><div style="font-size:48px;margin-bottom:10px;">‚úÖ</div>–í—Å—ë –≤ –ø–æ—Ä—è–¥–∫–µ! –ù–∏—á–µ–≥–æ –¥–æ–∫—É–ø–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ.</div>';
    } else {
        html += `<div style="color:#dc3545;font-weight:600;margin-bottom:15px;">–ù—É–∂–Ω–æ –¥–æ–∫—É–ø–∏—Ç—å: ${items.length} –ø–æ–∑–∏—Ü–∏–π</div>`;
        items.forEach(item => {
            const cat = state.categories.find(c => c.id === item.category);
            const need = item.minQuantity - item.quantity;
            const path = getContainerPath(item.container);
            const thumb = item.photo 
                ? `<img src="${item.photo}" style="width:40px;height:40px;border-radius:6px;object-fit:cover;margin-right:10px;">` 
                : `<span style="font-size:24px;margin-right:10px;">${cat ? cat.icon : 'üìå'}</span>`;
            
            html += `
                <div style="display:flex;align-items:center;padding:12px 0;border-bottom:1px solid #eee;">
                    ${thumb}
                    <div style="flex:1;">
                        <div style="font-weight:600;">${item.name}</div>
                        <div style="font-size:12px;color:#888;">üìç ${path}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="color:#dc3545;font-weight:700;">+${need}</div>
                        <div style="font-size:11px;color:#999;">–µ—Å—Ç—å ${item.quantity}/${item.minQuantity}</div>
                    </div>
                </div>
            `;
        });
    }
    
    document.getElementById('shoppingList').innerHTML = html;
    openModal('shoppingModal');
}

function shareShoppingList() {
    const items = getShoppingItems();
    if (items.length === 0) {
        showToast('–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç!');
        return;
    }
    
    let text = 'üõí –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ SKLADITO:\n\n';
    items.forEach(item => {
        const need = item.minQuantity - item.quantity;
        text += `‚òê ${item.name} ‚Äî ${need} —à—Ç.\n`;
    });
    text += `\n–í—Å–µ–≥–æ: ${items.length} –ø–æ–∑–∏—Ü–∏–π`;
    
    if (navigator.share) {
        navigator.share({ text }).catch(() => {
            navigator.clipboard.writeText(text);
            showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!');
        });
    } else {
        navigator.clipboard.writeText(text);
        showToast('–°–ø–∏—Å–æ–∫ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
    }
}

// –û–±–Ω–æ–≤–∏—Ç—å –±–µ–π–¥–∂ –≤ –±—É—Ä–≥–µ—Ä-–º–µ–Ω—é
function updateShoppingBadge() {
    const count = getShoppingItems().length;
    const badge = document.getElementById('shoppingBadge');
    if (badge) {
        badge.textContent = count > 0 ? `‚ö†Ô∏è –ù—É–∂–Ω–æ –¥–æ–∫—É–ø–∏—Ç—å: ${count}` : '–í—Å—ë –≤ –ø–æ—Ä—è–¥–∫–µ';
        badge.style.color = count > 0 ? '#dc3545' : '';
    }
}

// ==================== –°–ü–ò–°–ê–ù–ò–ï ====================

let writeOffTargetItem = null;

function openWriteOff() {
    document.getElementById('writeOffSearch').value = '';
    document.getElementById('writeOffResults').innerHTML = '<div style="text-align:center;color:#999;padding:20px;">–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞</div>';
    openModal('writeOffModal');
    document.getElementById('writeOffSearch').focus();
}

function searchWriteOff() {
    const query = document.getElementById('writeOffSearch').value.toLowerCase().trim();
    const results = document.getElementById('writeOffResults');
    
    if (query.length < 1) {
        results.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞</div>';
        return;
    }
    
    const found = state.items.filter(i => i.name.toLowerCase().includes(query));
    
    if (found.length === 0) {
        results.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
        return;
    }
    
    let html = '';
    found.forEach(item => {
        const cat = state.categories.find(c => c.id === item.category);
        const path = getContainerPath(item.container);
        const thumb = item.photo 
            ? `<img src="${item.photo}" style="width:40px;height:40px;border-radius:6px;object-fit:cover;margin-right:10px;">` 
            : `<span style="font-size:24px;margin-right:10px;">${cat ? cat.icon : 'üìå'}</span>`;
        
        html += `
            <div style="display:flex;align-items:center;padding:12px;border-bottom:1px solid #eee;cursor:pointer;border-radius:8px;" onclick="selectWriteOff('${item.id}')" onmousedown="this.style.background='#f0f0f0'" onmouseup="this.style.background=''">
                ${thumb}
                <div style="flex:1;">
                    <div style="font-weight:600;">${item.name}</div>
                    <div style="font-size:12px;color:#888;">üìç ${path}</div>
                </div>
                <div style="font-weight:700;color:#667eea;">√ó${item.quantity}</div>
            </div>
        `;
    });
    
    results.innerHTML = html;
}

function selectWriteOff(itemId) {
    const item = state.items.find(i => i.id === itemId);
    if (!item) return;
    
    writeOffTargetItem = item;
    
    const cat = state.categories.find(c => c.id === item.category);
    const path = getContainerPath(item.container);
    
    let html = `
        <div style="text-align:center;padding:10px 0;">
            ${item.photo ? `<img src="${item.photo}" style="width:80px;height:80px;border-radius:10px;object-fit:cover;margin-bottom:10px;">` : `<div style="font-size:48px;margin-bottom:10px;">${cat ? cat.icon : 'üìå'}</div>`}
            <div style="font-size:20px;font-weight:700;">${item.name}</div>
            <div style="font-size:14px;color:#888;margin-top:5px;">üìç ${path}</div>
            <div style="margin-top:10px;">
                <span style="font-size:28px;font-weight:700;color:#667eea;">√ó${item.quantity}</span>
                ${item.minQuantity > 0 ? `<span style="font-size:14px;color:#999;"> (–º–∏–Ω: ${item.minQuantity})</span>` : ''}
            </div>
        </div>
    `;
    
    document.getElementById('writeOffConfirmContent').innerHTML = html;
    document.getElementById('writeOffAmount').value = 1;
    document.getElementById('writeOffAmount').max = item.quantity;
    openModal('writeOffConfirmModal');
}

function confirmWriteOff() {
    if (!writeOffTargetItem) return;
    
    const amount = parseInt(document.getElementById('writeOffAmount').value) || 1;
    
    if (amount > writeOffTargetItem.quantity) {
        showToast('–ù–µ–ª—å–∑—è —Å–ø–∏—Å–∞—Ç—å –±–æ–ª—å—à–µ, —á–µ–º –µ—Å—Ç—å!');
        return;
    }
    
    writeOffTargetItem.quantity -= amount;
    saveToStorage();
    updateShoppingBadge();
    
    const belowMin = writeOffTargetItem.minQuantity > 0 && writeOffTargetItem.quantity < writeOffTargetItem.minQuantity;
    
    closeModal('writeOffConfirmModal');
    closeModal('writeOffModal');
    
    if (belowMin) {
        showToast(`–°–ø–∏—Å–∞–Ω–æ ${amount} —à—Ç. ‚ö†Ô∏è –ù—É–∂–Ω–æ –¥–æ–∫—É–ø–∏—Ç—å!`);
    } else {
        showToast(`–°–ø–∏—Å–∞–Ω–æ ${amount} —à—Ç. –û—Å—Ç–∞–ª–æ—Å—å: ${writeOffTargetItem.quantity}`);
    }
    
    writeOffTargetItem = null;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –≤–∏–¥
    if (state.viewMode === 'container') {
        openContainer(state.currentContainer);
    } else {
        renderMain();
    }
}

// –ó–ê–ü–£–°–ö
init();
    </script>
</body>
</html>

